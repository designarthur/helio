<div class="p-8">
    <h2 class="text-3xl font-bold text-gray-900 mb-6">Quotes, Invoices & Payments</h2>

    <div class="flex border-b border-gray-200 mb-8 space-x-6">
        <span class="finance-tab py-2 px-0 cursor-pointer font-bold text-gray-500 transition-colors duration-300 hover:text-gray-800 border-b-2 border-transparent text-[#EA3A26] border-[#EA3A26]" data-tab="quotes">Quotes</span>
        <span class="finance-tab py-2 px-0 cursor-pointer font-bold text-gray-500 transition-colors duration-300 hover:text-gray-800 border-b-2 border-transparent" data-tab="invoices">Invoices</span>
        <span class="finance-tab py-2 px-0 cursor-pointer font-bold text-gray-500 transition-colors duration-300 hover:text-gray-800 border-b-2 border-transparent" data-tab="payments">Payments</span>
    </div>

    <div id="finance-tab-quotes" class="finance-content-view">
        <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
            <button id="addQuoteBtn" class="px-6 py-3 bg-[#EA3A26] text-white rounded-md font-semibold hover:bg-[#F54F1D] transition-colors duration-200 flex items-center gap-2">
                <i class="fas fa-file-invoice"></i> Create New Quote
            </button>
            <input type="text" id="quoteSearch" placeholder="Search by ID, Customer..." onkeyup="filterQuotes()"
                   class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#EA3A26] w-full md:w-auto">
            <select id="quoteStatusFilter" onchange="filterQuotes()"
                    class="px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#EA3A26] w-full md:w-auto">
                <option value="">All Statuses</option>
                <option value="Draft">Draft</option>
                <option value="Sent">Sent</option>
                <option value="Accepted">Accepted</option>
                <option value="Rejected">Rejected</option>
                <option value="Expired">Expired</option>
            </select>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-x-auto mb-8">
            <table class="min-w-full divide-y divide-gray-200" id="quotesTable">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quote ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="finance-tab-invoices" class="finance-content-view hidden">
        <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
            <button id="addInvoiceBtn" class="px-6 py-3 bg-[#EA3A26] text-white rounded-md font-semibold hover:bg-[#F54F1D] transition-colors duration-200 flex items-center gap-2">
                <i class="fas fa-plus-circle"></i> Create Manual Invoice
            </button>
            <input type="text" id="invoiceSearch" placeholder="Search by ID, Customer..." onkeyup="filterInvoices()"
                   class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#EA3A26] w-full md:w-auto">
            <select id="invoiceStatusFilter" onchange="filterInvoices()"
                    class="px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#EA3A26] w-full md:w-auto">
                <option value="">All Statuses</option>
                <option value="Sent">Sent</option>
                <option value="Paid">Paid</option>
                <option value="Partially Paid">Partially Paid</option>
                <option value="Overdue">Overdue</option>
                <option value="Voided">Voided</option>
            </select>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-x-auto mb-8">
            <table class="min-w-full divide-y divide-gray-200" id="invoicesTable">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issue Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="finance-tab-payments" class="finance-content-view hidden">
        <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
            <button id="recordPaymentBtn" class="px-6 py-3 bg-[#EA3A26] text-white rounded-md font-semibold hover:bg-[#F54F1D] transition-colors duration-200 flex items-center gap-2">
                <i class="fas fa-money-bill-wave"></i> Record New Payment
            </button>
            <input type="text" id="paymentSearch" placeholder="Search by ID, Invoice..." onkeyup="filterPayments()"
                   class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#EA3A26] w-full md:w-auto">
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-x-auto mb-8">
            <table class="min-w-full divide-y divide-gray-200" id="paymentsTable">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="quoteModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 max-w-3xl relative max-h-[90vh] overflow-y-auto">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" onclick="closeModal('quoteModal')">&times;</button>
            <h3 id="quoteModalTitle" class="text-2xl font-bold text-[#EA3A26] mb-6 border-b pb-3 border-gray-200">Create New Quote</h3>
            <form id="quoteForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="quoteId">

                <div class="col-span-1 md:col-span-2">
                    <label for="quoteCustomerId" class="block text-sm font-medium text-gray-700 mb-1">Customer:</label>
                    <select id="quoteCustomerId" required onchange="updateQuoteItemsDropdowns()"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                        <option value="">Select Customer</option>
                        </select>
                </div>

                <div class="col-span-1 md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quote Items:</label>
                    <div id="quoteItemsContainer" class="space-y-3 border p-3 rounded-md bg-gray-50">
                        <div class="flex flex-wrap items-end gap-2 p-2 border-b border-gray-200 last:border-b-0">
                            <select class="flex-grow min-w-[150px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none equipment-select" onchange="calculateQuoteTotal()">
                                <option value="">Select Equipment</option>
                            </select>
                            <input type="number" placeholder="Days" min="1" class="w-20 px-3 py-2 border border-gray-300 rounded-md days-input" onchange="calculateQuoteTotal()">
                            <button type="button" class="text-red-600 hover:text-red-800" onclick="removeQuoteItem(this)"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>
                    <button type="button" id="addQuoteItemBtn" class="mt-3 px-4 py-2 bg-gray-200 text-gray-700 rounded-md text-sm hover:bg-gray-300 transition-colors duration-200">Add Item</button>
                </div>

                <div class="col-span-1 md:col-span-2">
                    <label for="quoteDeliveryFee" class="block text-sm font-medium text-gray-700 mb-1">Delivery Fee ($):</label>
                    <input type="number" id="quoteDeliveryFee" min="0" step="0.01" value="0.00" onchange="calculateQuoteTotal()"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="quotePickupFee" class="block text-sm font-medium text-gray-700 mb-1">Pickup Fee ($):</label>
                    <input type="number" id="quotePickupFee" min="0" step="0.01" value="0.00" onchange="calculateQuoteTotal()"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="quoteDamageWaiver" class="block text-sm font-medium text-gray-700 mb-1">Damage Waiver ($):</label>
                    <input type="number" id="quoteDamageWaiver" min="0" step="0.01" value="0.00" onchange="calculateQuoteTotal()"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="quoteNotes" class="block text-sm font-medium text-gray-700 mb-1">Notes/Terms:</label>
                    <textarea id="quoteNotes" rows="3"
                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26] resize-y"></textarea>
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="quoteStatus" class="block text-sm font-medium text-gray-700 mb-1">Status:</label>
                    <select id="quoteStatus" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                        <option value="Draft">Draft</option>
                        <option value="Sent">Sent</option>
                        <option value="Accepted">Accepted</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Expired">Expired</option>
                    </select>
                </div>
                <div class="col-span-1 md:col-span-2 text-right">
                    <label class="block text-xl font-bold text-gray-800 mb-1">Total Quote Amount:</label>
                    <span class="text-3xl font-extrabold text-[#EA3A26]" id="quoteTotal">$0.00</span>
                </div>

                <div class="col-span-1 md:col-span-2 flex justify-end gap-3 mt-6">
                    <button type="button" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md font-semibold hover:bg-gray-400 transition-colors duration-200" onclick="closeModal('quoteModal')">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-[#EA3A26] text-white rounded-md font-semibold hover:bg-[#F54F1D] transition-colors duration-200">Save Quote</button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewQuoteModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 max-w-3xl relative max-h-[90vh] overflow-y-auto">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" onclick="closeModal('viewQuoteModal')">&times;</button>
            <h3 class="text-2xl font-bold text-[#EA3A26] mb-6 border-b pb-3 border-gray-200">Quote Details: <span id="detailQuoteId"></span></h3>
            <div class="space-y-4 text-gray-700">
                <div class="bg-gray-50 p-4 rounded-md shadow-sm">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2 border-b border-dashed border-gray-300 pb-2">Quote Information</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <p><strong>Customer:</strong> <span id="detailQuoteCustomerName"></span></p>
                        <p><strong>Quote Date:</strong> <span id="detailQuoteDate"></span></p>
                        <p><strong>Status:</strong> <span id="detailQuoteStatus" class="px-2 py-1 rounded-full text-xs font-bold uppercase text-white"></span></p>
                        <p><strong>Total Amount:</strong> $<span id="detailQuoteTotal"></span></p>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-md shadow-sm">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2 border-b border-dashed border-gray-300 pb-2">Items Quoted</h4>
                    <ul id="detailQuoteItemsList" class="list-disc list-inside ml-4 space-y-1">
                        </ul>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-md shadow-sm">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2 border-b border-dashed border-gray-300 pb-2">Additional Fees</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <p><strong>Delivery Fee:</strong> $<span id="detailQuoteDeliveryFee"></span></p>
                        <p><strong>Pickup Fee:</strong> $<span id="detailQuotePickupFee"></span></p>
                        <p><strong>Damage Waiver:</strong> $<span id="detailQuoteDamageWaiver"></span></p>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-md shadow-sm hidden" id="detailQuoteNotesGroup">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2 border-b border-dashed border-gray-300 pb-2">Notes/Terms</h4>
                    <p><span id="detailQuoteNotes"></span></p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md font-semibold hover:bg-gray-400 transition-colors duration-200" onclick="closeModal('viewQuoteModal')">Close</button>
                <button type="button" class="px-6 py-2 bg-[#EA3A26] text-white rounded-md font-semibold hover:bg-[#F54F1D] transition-colors duration-200" id="editQuoteFromDetailBtn">Edit Quote</button>
                <button type="button" class="px-6 py-2 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200" onclick="simulateQuoteAction('send')">Send Quote</button>
                <button type="button" class="px-6 py-2 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 transition-colors duration-200" id="acceptQuoteBtn">Accept & Convert</button>
            </div>
        </div>
    </div>

    <div id="viewInvoiceModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 max-w-3xl relative max-h-[90vh] overflow-y-auto">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" onclick="closeModal('viewInvoiceModal')">&times;</button>
            <h3 class="text-2xl font-bold text-[#EA3A26] mb-6 border-b pb-3 border-gray-200">Invoice Details: <span id="detailInvoiceId"></span></h3>
            <div class="space-y-4 text-gray-700">
                <div class="bg-gray-50 p-4 rounded-md shadow-sm">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2 border-b border-dashed border-gray-300 pb-2">Invoice Information</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <p><strong>Customer:</strong> <span id="detailInvoiceCustomerName"></span></p>
                        <p><strong>Issue Date:</strong> <span id="detailInvoiceIssueDate"></span></p>
                        <p><strong>Due Date:</strong> <span id="detailInvoiceDueDate"></span></p>
                        <p><strong>Total Amount:</strong> $<span id="detailInvoiceTotal"></span></p>
                        <p><strong>Balance Due:</strong> $<span id="detailInvoiceBalanceDue"></span></p>
                        <p><strong>Status:</strong> <span id="detailInvoiceStatus" class="px-2 py-1 rounded-full text-xs font-bold uppercase text-white"></span></p>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-md shadow-sm">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2 border-b border-dashed border-gray-300 pb-2">Items</h4>
                    <ul id="detailInvoiceItemsList" class="list-disc list-inside ml-4 space-y-1">
                        </ul>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md font-semibold hover:bg-gray-400 transition-colors duration-200" onclick="closeModal('viewInvoiceModal')">Close</button>
                <button type="button" class="px-6 py-2 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 transition-colors duration-200" id="markAsPaidBtn">Mark As Paid</button>
            </div>
        </div>
    </div>

    <div id="recordPaymentModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 max-w-md relative">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" onclick="closeModal('recordPaymentModal')">&times;</button>
            <h3 class="text-2xl font-bold text-[#EA3A26] mb-6 border-b pb-3 border-gray-200">Record New Payment</h3>
            <form id="paymentForm" class="space-y-4">
                <input type="hidden" id="paymentForInvoiceId">
                <div>
                    <label for="paymentInvoiceId" class="block text-sm font-medium text-gray-700 mb-1">Invoice ID:</label>
                    <input type="text" id="paymentInvoiceId" placeholder="INVXXX (Optional)"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                </div>
                <div>
                    <label for="paymentAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount ($):</label>
                    <input type="number" id="paymentAmount" min="0.01" step="0.01" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                </div>
                <div>
                    <label for="paymentMethod" class="block text-sm font-medium text-gray-700 mb-1">Payment Method:</label>
                    <select id="paymentMethod" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                        <option value="">Select Method</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="ACH">ACH/Bank Transfer</option>
                        <option value="Check">Check</option>
                        <option value="Cash">Cash</option>
                    </select>
                </div>
                <div>
                    <label for="paymentDate" class="block text-sm font-medium text-gray-700 mb-1">Payment Date:</label>
                    <input type="date" id="paymentDate" value="" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md font-semibold hover:bg-gray-400 transition-colors duration-200" onclick="closeModal('recordPaymentModal')">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-[#EA3A26] text-white rounded-md font-semibold hover:bg-[#F54F1D] transition-colors duration-200">Record Payment</button>
                </div>
            </form>
        </div>
    </div>

</div>

<script>
(function() { // Wrap in IIFE
    // Access global data directly from the window object
    const customerData = window.customerData;
    const equipmentData = window.equipmentData;
    let quotesData = window.quotesData; // Use 'let' if you reassign this array
    let invoicesData = window.invoicesData; // Use 'let'
    let paymentsData = window.paymentsData; // Use 'let'
    const bookingData = window.bookingData; // Use 'const'

    let currentQuoteId = null; // For editing quotes
    let currentInvoiceId = null; // For editing/marking paid invoices

    // Get elements
    const financeTabs = document.querySelectorAll('.finance-tab');
    const financeContentViews = document.querySelectorAll('.finance-content-view');

    // Quotes Tab elements
    const addQuoteBtn = document.getElementById('addQuoteBtn');
    const quotesTableBody = document.querySelector('#quotesTable tbody');
    const quoteModal = document.getElementById('quoteModal');
    const quoteModalTitle = document.getElementById('quoteModalTitle');
    const quoteForm = document.getElementById('quoteForm');
    const quoteIdField = document.getElementById('quoteId');
    const quoteCustomerIdSelect = document.getElementById('quoteCustomerId');
    const quoteItemsContainer = document.getElementById('quoteItemsContainer');
    const addQuoteItemBtn = document.getElementById('addQuoteItemBtn');
    const quoteDeliveryFeeInput = document.getElementById('quoteDeliveryFee');
    const quotePickupFeeInput = document.getElementById('quotePickupFee');
    const quoteDamageWaiverInput = document.getElementById('quoteDamageWaiver');
    const quoteNotesInput = document.getElementById('quoteNotes');
    const quoteStatusSelect = document.getElementById('quoteStatus');
    const quoteTotalDisplay = document.getElementById('quoteTotal');

    // View Quote Modal elements
    const viewQuoteModal = document.getElementById('viewQuoteModal');
    const detailQuoteId = document.getElementById('detailQuoteId');
    const detailQuoteCustomerName = document.getElementById('detailQuoteCustomerName');
    const detailQuoteDate = document.getElementById('detailQuoteDate');
    const detailQuoteStatus = document.getElementById('detailQuoteStatus');
    const detailQuoteTotal = document.getElementById('detailQuoteTotal');
    const detailQuoteItemsList = document.getElementById('detailQuoteItemsList');
    const detailQuoteDeliveryFee = document.getElementById('detailQuoteDeliveryFee');
    const detailQuotePickupFee = document.getElementById('detailQuotePickupFee');
    const detailQuoteDamageWaiver = document.getElementById('detailQuoteDamageWaiver');
    const detailQuoteNotes = document.getElementById('detailQuoteNotes');
    const detailQuoteNotesGroup = document.getElementById('detailQuoteNotesGroup');
    const editQuoteFromDetailBtn = document.getElementById('editQuoteFromDetailBtn');
    const acceptQuoteBtn = document.getElementById('acceptQuoteBtn');

    // Invoices Tab elements
    const addInvoiceBtn = document.getElementById('addInvoiceBtn');
    const invoicesTableBody = document.querySelector('#invoicesTable tbody');

    // View Invoice Modal elements
    const viewInvoiceModal = document.getElementById('viewInvoiceModal');
    const detailInvoiceId = document.getElementById('detailInvoiceId');
    const detailInvoiceCustomerName = document.getElementById('detailInvoiceCustomerName');
    const detailInvoiceIssueDate = document.getElementById('detailInvoiceIssueDate');
    const detailInvoiceDueDate = document.getElementById('detailInvoiceDueDate');
    const detailInvoiceTotal = document.getElementById('detailInvoiceTotal');
    const detailInvoiceBalanceDue = document.getElementById('detailInvoiceBalanceDue');
    const detailInvoiceStatus = document.getElementById('detailInvoiceStatus');
    const detailInvoiceItemsList = document.getElementById('detailInvoiceItemsList');
    const markAsPaidBtn = document.getElementById('markAsPaidBtn');

    // Payments Tab elements
    const recordPaymentBtn = document.getElementById('recordPaymentBtn');
    const paymentsTableBody = document.querySelector('#paymentsTable tbody');
    const recordPaymentModal = document.getElementById('recordPaymentModal');
    const paymentForm = document.getElementById('paymentForm');
    const paymentForInvoiceIdField = document.getElementById('paymentForInvoiceId');
    const paymentInvoiceIdInput = document.getElementById('paymentInvoiceId');
    const paymentAmountInput = document.getElementById('paymentAmount');
    const paymentMethodSelect = document.getElementById('paymentMethod');
    const paymentDateInput = document.getElementById('paymentDate');


    // --- General Modal Functions ---
    // Assuming openModal and closeModal are defined globally in index.html
    function openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
    }
    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        if (modalId === 'quoteModal') {
            quoteForm.reset();
            currentQuoteId = null;
            renderQuoteItems(null); // Clear quote items
            calculateQuoteTotal(); // Reset total
        }
        if (modalId === 'recordPaymentModal') {
            paymentForm.reset();
            paymentForInvoiceIdField.value = '';
            paymentInvoiceIdInput.disabled = false; // Enable if it was disabled
            paymentDateInput.valueAsDate = new Date(); // Set current date
        }
    }

    // --- Tab Switching ---
    function switchFinanceView(tabName) {
        financeContentViews.forEach(view => view.classList.add('hidden'));
        document.getElementById(`finance-tab-${tabName}`).classList.remove('hidden');

        financeTabs.forEach(tab => {
            tab.classList.remove('text-[#EA3A26]', 'border-[#EA3A26]');
            tab.classList.add('text-gray-500', 'border-transparent');
        });
        const activeTab = Array.from(financeTabs).find(tab => tab.dataset.tab === tabName);
        if (activeTab) {
            activeTab.classList.add('text-[#EA3A26]', 'border-[#EA3A26]');
            activeTab.classList.remove('text-gray-500', 'border-transparent');
        }

        // Render content for the active tab
        if (tabName === 'quotes') {
            renderQuotesTable();
        } else if (tabName === 'invoices') {
            renderInvoicesTable();
        } else if (tabName === 'payments') {
            renderPaymentsTable();
        }
    }

    // --- Quote Functions ---
    function populateCustomerAndEquipmentDropdowns(customerIdSelectElement, equipmentSelectElements) {
        // Populate Customer Select
        customerIdSelectElement.innerHTML = '<option value="">Select Customer</option>';
        if (Array.isArray(customerData)) {
            customerData.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} (${customer.company || 'Residential'})`;
                customerIdSelectElement.appendChild(option);
            });
        }

        // Populate Equipment Selects (for each item row)
        equipmentSelectElements.forEach(select => {
            select.innerHTML = '<option value="">Select Equipment</option>';
            if (Array.isArray(equipmentData)) {
                equipmentData.forEach(equipment => {
                    const option = document.createElement('option');
                    option.value = equipment.id;
                    option.textContent = `${equipment.type} - ${equipment.size} (ID: ${equipment.id})`;
                    select.appendChild(option);
                });
            }
        });
    }

    function renderQuoteItems(items = [{ equipmentId: '', rentalDays: 0, unitPrice: 0 }]) {
        quoteItemsContainer.innerHTML = ''; // Clear existing items

        if (!Array.isArray(items) || items.length === 0) {
             items = [{ equipmentId: '', rentalDays: 0, unitPrice: 0 }]; // Ensure at least one empty item
        }

        items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('flex', 'flex-wrap', 'items-end', 'gap-2', 'p-2', 'border-b', 'border-gray-200', 'last:border-b-0');
            itemDiv.innerHTML = `
                <select class="flex-grow min-w-[150px] px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-[#EA3A26] equipment-select" onchange="calculateQuoteTotal()">
                    <option value="">Select Equipment</option>
                </select>
                <input type="number" placeholder="Days" min="1" class="w-20 px-3 py-2 border border-gray-300 rounded-md days-input" onchange="calculateQuoteTotal()">
                <button type="button" class="text-red-600 hover:text-red-800" onclick="removeQuoteItem(this)"><i class="fas fa-trash-alt"></i></button>
            `;
            quoteItemsContainer.appendChild(itemDiv);

            // Populate the newly added equipment select
            const equipmentSelect = itemDiv.querySelector('.equipment-select');
            populateCustomerAndEquipmentDropdowns(quoteCustomerIdSelect, [equipmentSelect]); // Pass a single-element array for the new select
            
            // Set values if editing
            if (item.equipmentId) {
                equipmentSelect.value = item.equipmentId;
            }
            if (item.rentalDays) {
                itemDiv.querySelector('.days-input').value = item.rentalDays;
            }
        });
        calculateQuoteTotal(); // Recalculate after rendering items
    }

    function addQuoteItem() {
        renderQuoteItems([{ equipmentId: '', rentalDays: '' }]);
    }

    function removeQuoteItem(button) {
        if (quoteItemsContainer.children.length > 1) { // Don't remove if it's the last item
            button.closest('div').remove();
            calculateQuoteTotal();
        } else {
            alert('A quote must have at least one item.');
        }
    }

    function calculateQuoteTotal() {
        let total = 0;
        const items = [];
        quoteItemsContainer.querySelectorAll('.flex.flex-wrap').forEach(itemDiv => {
            const equipmentId = itemDiv.querySelector('.equipment-select').value;
            const rentalDays = parseInt(itemDiv.querySelector('.days-input').value) || 0;
            
            const equipment = equipmentData.find(eq => eq.id === equipmentId);
            if (equipment && equipment.baseDailyRate && rentalDays > 0) {
                const itemTotalPrice = equipment.baseDailyRate * rentalDays;
                total += itemTotalPrice;
                items.push({ equipmentId: equipmentId, rentalDays: rentalDays, unitPrice: equipment.baseDailyRate, itemTotalPrice: itemTotalPrice });
            }
        });

        const deliveryFee = parseFloat(quoteDeliveryFeeInput.value) || 0;
        const pickupFee = parseFloat(quotePickupFeeInput.value) || 0;
        const damageWaiver = parseFloat(quoteDamageWaiverInput.value) || 0;

        total += deliveryFee + pickupFee + damageWaiver;

        quoteTotalDisplay.textContent = `$${total.toFixed(2)}`;
    }

    addQuoteItemBtn.addEventListener('click', addQuoteItem);
    quoteForm.addEventListener('submit', saveQuote);

    function renderQuotesTable(dataToRender = quotesData) {
        quotesTableBody.innerHTML = '';
        if (!Array.isArray(dataToRender) || dataToRender.length === 0) {
            const row = quotesTableBody.insertRow();
            row.innerHTML = '<td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No quotes found.</td>';
            return;
        }
        dataToRender.forEach(quote => {
            const row = quotesTableBody.insertRow();
            const customer = customerData.find(c => c.id === quote.customerId);
            row.classList.add('hover:bg-gray-50');

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900').textContent = quote.id;
            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500').textContent = customer ? customer.name : 'Unknown';
            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500').textContent = quote.quoteDate;
            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500').textContent = `$${quote.totalAmount.toFixed(2)}`;
            
            const statusCell = row.insertCell();
            const statusSpan = document.createElement('span');
            statusSpan.textContent = quote.status;
            statusSpan.classList.add('px-2', 'py-1', 'rounded-full', 'text-xs', 'font-bold', 'uppercase', 'text-white');
            if (quote.status === 'Accepted') statusSpan.classList.add('bg-green-600');
            else if (quote.status === 'Sent') statusSpan.classList.add('bg-blue-600');
            else if (quote.status === 'Draft') statusSpan.classList.add('bg-gray-500');
            else if (quote.status === 'Rejected' || quote.status === 'Expired') statusSpan.classList.add('bg-red-600');
            statusCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
            statusCell.appendChild(statusSpan);

            const actionsCell = row.insertCell();
            actionsCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-right', 'text-sm', 'font-medium');
            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'View';
            viewBtn.classList.add('text-indigo-600', 'hover:text-indigo-900', 'mr-3', 'transition-colors', 'duration-200');
            viewBtn.onclick = () => viewQuoteDetails(quote.id);
            actionsCell.appendChild(viewBtn);

            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.classList.add('text-[#EA3A26]', 'hover:text-[#F54F1D]', 'mr-3', 'transition-colors', 'duration-200');
            editBtn.onclick = () => openEditQuoteModal(quote.id);
            actionsCell.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.classList.add('text-red-600', 'hover:text-red-900', 'transition-colors', 'duration-200');
            deleteBtn.onclick = () => deleteQuote(quote.id);
            actionsCell.appendChild(deleteBtn);
        });
    }

    function openAddQuoteModal() {
        quoteModalTitle.textContent = 'Create New Quote';
        quoteIdField.value = '';
        quoteForm.reset();
        currentQuoteId = null;
        renderQuoteItems([]); // Start with empty item list
        populateCustomerAndEquipmentDropdowns(quoteCustomerIdSelect, quoteItemsContainer.querySelectorAll('.equipment-select'));
        quoteDeliveryFeeInput.value = '0.00';
        quotePickupFeeInput.value = '0.00';
        quoteDamageWaiverInput.value = '0.00';
        quoteStatusSelect.value = 'Draft';
        quoteTotalDisplay.textContent = '$0.00';
        openModal('quoteModal');
    }

    function openEditQuoteModal(id) {
        const quote = quotesData.find(q => q.id === id);
        if (quote) {
            quoteModalTitle.textContent = `Edit Quote: ${quote.id}`;
            quoteIdField.value = quote.id;
            currentQuoteId = id;

            populateCustomerAndEquipmentDropdowns(quoteCustomerIdSelect, []); // Populate customer dropdown first
            quoteCustomerIdSelect.value = quote.customerId;

            renderQuoteItems(quote.items); // Render items and populate their equipment dropdowns

            quoteDeliveryFeeInput.value = quote.deliveryFee.toFixed(2);
            quotePickupFeeInput.value = quote.pickupFee.toFixed(2);
            quoteDamageWaiverInput.value = quote.damageWaiver.toFixed(2);
            quoteNotesInput.value = quote.notes || '';
            quoteStatusSelect.value = quote.status;
            calculateQuoteTotal(); // Ensure total is correct after setting all fields

            openModal('quoteModal');
        } else {
            alert('Quote not found for editing.');
        }
    }

    function saveQuote(event) {
        event.preventDefault();
        const id = quoteIdField.value;
        const customerId = quoteCustomerIdSelect.value;
        const quoteDate = new Date().toISOString().split('T')[0]; // Current date
        const notes = quoteNotesInput.value;
        const status = quoteStatusSelect.value;

        const items = [];
        let totalAmount = 0;

        // Collect items and calculate total
        quoteItemsContainer.querySelectorAll('.flex.flex-wrap').forEach(itemDiv => {
            const equipmentId = itemDiv.querySelector('.equipment-select').value;
            const rentalDays = parseInt(itemDiv.querySelector('.days-input').value) || 0;
            
            const equipment = equipmentData.find(eq => eq.id === equipmentId);
            if (equipment && equipment.baseDailyRate && rentalDays > 0) {
                const itemTotal = equipment.baseDailyRate * rentalDays;
                items.push({ equipmentId: equipmentId, rentalDays: rentalDays, unitPrice: equipment.baseDailyRate, itemTotalPrice: itemTotal });
                totalAmount += itemTotal;
            }
        });

        const deliveryFee = parseFloat(quoteDeliveryFeeInput.value) || 0;
        const pickupFee = parseFloat(quotePickupFeeInput.value) || 0;
        const damageWaiver = parseFloat(quoteDamageWaiverInput.value) || 0;

        totalAmount += deliveryFee + pickupFee + damageWaiver;

        if (!customerId || items.length === 0 || totalAmount <= 0) {
            alert('Please select a customer, add at least one valid equipment item, and ensure total is greater than 0.');
            return;
        }

        let newQuote = {
            id: id,
            customerId: customerId,
            quoteDate: quoteDate,
            items: items,
            deliveryFee: deliveryFee,
            pickupFee: pickupFee,
            damageWaiver: damageWaiver,
            totalAmount: totalAmount,
            notes: notes,
            status: status
        };

        if (id) {
            const index = quotesData.findIndex(q => q.id === id);
            if (index !== -1) {
                quotesData[index] = newQuote;
                alert(`Quote ${id} updated successfully!`);
            } else {
                alert(`Error: Quote ${id} not found for update.`);
            }
        } else {
            newQuote.id = 'QUO' + (quotesData.length + 1).toString().padStart(3, '0');
            quotesData.push(newQuote);
            alert(`New quote ${newQuote.id} created successfully!`);
        }

        renderQuotesTable();
        closeModal('quoteModal');
    }

    function deleteQuote(id) {
        if (confirm(`Are you sure you want to delete Quote ID: ${id}?`)) {
            quotesData = quotesData.filter(q => q.id !== id);
            renderQuotesTable();
            alert(`Quote ${id} deleted.`);
        }
    }

    function viewQuoteDetails(id) {
        const quote = quotesData.find(q => q.id === id);
        if (quote) {
            const customer = customerData.find(c => c.id === quote.customerId);

            detailQuoteId.textContent = quote.id;
            detailQuoteCustomerName.textContent = customer ? customer.name : 'Unknown';
            detailQuoteDate.textContent = quote.quoteDate;
            detailQuoteTotal.textContent = quote.totalAmount.toFixed(2);
            
            // Status styling
            detailQuoteStatus.textContent = quote.status;
            detailQuoteStatus.classList.remove('bg-green-600', 'bg-blue-600', 'bg-gray-500', 'bg-red-600');
            if (quote.status === 'Accepted') detailQuoteStatus.classList.add('bg-green-600');
            else if (quote.status === 'Sent') detailQuoteStatus.classList.add('bg-blue-600');
            else if (quote.status === 'Draft') detailQuoteStatus.classList.add('bg-gray-500');
            else if (quote.status === 'Rejected' || quote.status === 'Expired') detailQuoteStatus.classList.add('bg-red-600');

            detailQuoteItemsList.innerHTML = '';
            quote.items.forEach(item => {
                const equipment = equipmentData.find(eq => eq.id === item.equipmentId);
                const li = document.createElement('li');
                li.textContent = `${equipment ? `${equipment.type} (${equipment.size})` : item.equipmentId} for ${item.rentalDays} days @ $${item.unitPrice.toFixed(2)}/day (Subtotal: $${item.itemTotalPrice.toFixed(2)})`;
                detailQuoteItemsList.appendChild(li);
            });

            detailQuoteDeliveryFee.textContent = quote.deliveryFee.toFixed(2);
            detailQuotePickupFee.textContent = quote.pickupFee.toFixed(2);
            detailQuoteDamageWaiver.textContent = quote.damageWaiver.toFixed(2);

            if (quote.notes) {
                detailQuoteNotesGroup.classList.remove('hidden');
                detailQuoteNotes.textContent = quote.notes;
            } else {
                detailQuoteNotesGroup.classList.add('hidden');
            }

            // Enable/disable Accept & Convert button based on status
            if (quote.status === 'Sent' || quote.status === 'Draft') {
                acceptQuoteBtn.classList.remove('hidden');
                acceptQuoteBtn.onclick = () => convertQuoteToBookingAndInvoice(quote.id);
            } else {
                acceptQuoteBtn.classList.add('hidden');
            }

            editQuoteFromDetailBtn.onclick = () => {
                closeModal('viewQuoteModal');
                openEditQuoteModal(quote.id);
            }

            openModal('viewQuoteModal');
        } else {
            alert('Quote details not found.');
        }
    }

    function filterQuotes() {
        const searchTerm = document.getElementById('quoteSearch').value.toLowerCase();
        const statusFilter = document.getElementById('quoteStatusFilter').value;

        const filteredData = quotesData.filter(quote => {
            const customer = customerData.find(c => c.id === quote.customerId);
            const customerName = customer ? customer.name.toLowerCase() : '';

            const matchesSearch = quote.id.toLowerCase().includes(searchTerm) ||
                                  customerName.includes(searchTerm) ||
                                  (quote.notes && quote.notes.toLowerCase().includes(searchTerm));
            const matchesStatus = statusFilter === '' || quote.status === statusFilter;

            return matchesSearch && matchesStatus;
        });
        renderQuotesTable(filteredData);
    }

    // --- Invoice Functions ---
    addInvoiceBtn.addEventListener('click', createManualInvoice);

    function renderInvoicesTable(dataToRender = invoicesData) {
        invoicesTableBody.innerHTML = '';
        if (!Array.isArray(dataToRender) || dataToRender.length === 0) {
            const row = invoicesTableBody.insertRow();
            row.innerHTML = '<td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No invoices found.</td>';
            return;
        }
        dataToRender.forEach(invoice => {
            const row = invoicesTableBody.insertRow();
            const customer = customerData.find(c => c.id === invoice.customerId);
            row.classList.add('hover:bg-gray-50');

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900').textContent = invoice.id;
            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500').textContent = customer ? customer.name : 'Unknown';
            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500').textContent = invoice.issueDate;
            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500').textContent = invoice.dueDate;
            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500').textContent = `$${invoice.totalAmount.toFixed(2)}`;
            
            const statusCell = row.insertCell();
            const statusSpan = document.createElement('span');
            statusSpan.textContent = invoice.status;
            statusSpan.classList.add('px-2', 'py-1', 'rounded-full', 'text-xs', 'font-bold', 'uppercase', 'text-white');
            if (invoice.status === 'Paid') statusSpan.classList.add('bg-green-600');
            else if (invoice.status === 'Sent') statusSpan.classList.add('bg-blue-600');
            else if (invoice.status === 'Partially Paid') statusSpan.classList.add('bg-[#FF8600]'); // UT Orange
            else if (invoice.status === 'Overdue') statusSpan.classList.add('bg-red-600');
            else if (invoice.status === 'Voided') statusSpan.classList.add('bg-gray-500');
            statusCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
            statusCell.appendChild(statusSpan);

            const actionsCell = row.insertCell();
            actionsCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-right', 'text-sm', 'font-medium');
            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'View';
            viewBtn.classList.add('text-indigo-600', 'hover:text-indigo-900', 'transition-colors', 'duration-200');
            viewBtn.onclick = () => viewInvoiceDetails(invoice.id);
            actionsCell.appendChild(viewBtn);
        });
    }

    function createManualInvoice() {
        alert('Simulating creating a manual invoice.\n(In a real app, this would open a form to input invoice details.)');
        const newInvoiceId = 'INV' + (invoicesData.length + 1).toString().padStart(3, '0');
        const dummyInvoice = {
            id: newInvoiceId,
            customerId: 'CUST001', // Default to a dummy customer
            issueDate: new Date().toISOString().split('T')[0],
            dueDate: new Date(new Date().setDate(new Date().getDate() + 30)).toISOString().split('T')[0], // 30 days from now
            items: [{ description: 'Manual Service Charge', amount: 100.00, unitPrice: 100.00, quantity: 1 }],
            totalAmount: 100.00,
            balanceDue: 100.00,
            status: 'Sent',
            linkedBookingId: '',
            linkedQuoteId: ''
        };
        invoicesData.push(dummyInvoice);
        renderInvoicesTable();
        alert(`Dummy Manual Invoice ${newInvoiceId} created.`);
    }

    function viewInvoiceDetails(id) {
        const invoice = invoicesData.find(i => i.id === id);
        if (invoice) {
            const customer = customerData.find(c => c.id === invoice.customerId);

            detailInvoiceId.textContent = invoice.id;
            detailInvoiceCustomerName.textContent = customer ? customer.name : 'Unknown';
            detailInvoiceIssueDate.textContent = invoice.issueDate;
            detailInvoiceDueDate.textContent = invoice.dueDate;
            detailInvoiceTotal.textContent = invoice.totalAmount.toFixed(2);
            detailInvoiceBalanceDue.textContent = invoice.balanceDue.toFixed(2);

            // Status styling
            detailInvoiceStatus.textContent = invoice.status;
            detailInvoiceStatus.classList.remove('bg-green-600', 'bg-blue-600', 'bg-gray-500', 'bg-red-600', 'bg-[#FF8600]');
            if (invoice.status === 'Paid') detailInvoiceStatus.classList.add('bg-green-600');
            else if (invoice.status === 'Sent') detailInvoiceStatus.classList.add('bg-blue-600');
            else if (invoice.status === 'Partially Paid') detailInvoiceStatus.classList.add('bg-[#FF8600]');
            else if (invoice.status === 'Overdue') detailInvoiceStatus.classList.add('bg-red-600');
            else if (invoice.status === 'Voided') detailInvoiceStatus.classList.add('bg-gray-500');

            detailInvoiceItemsList.innerHTML = '';
            invoice.items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.description} - $${item.amount.toFixed(2)}`;
                detailInvoiceItemsList.appendChild(li);
            });

            // Configure Mark as Paid button
            if (invoice.balanceDue > 0) {
                markAsPaidBtn.classList.remove('hidden');
                markAsPaidBtn.onclick = () => markInvoiceAsPaid(invoice.id);
            } else {
                markAsPaidBtn.classList.add('hidden');
            }
            
            openModal('viewInvoiceModal');
        } else {
            alert('Invoice details not found.');
        }
    }

    function markInvoiceAsPaid(invoiceId) {
        const invoice = invoicesData.find(i => i.id === invoiceId);
        if (invoice && invoice.balanceDue > 0) {
            // Simulate full payment
            invoice.balanceDue = 0;
            invoice.status = 'Paid';

            // Record payment automatically
            const newPaymentId = 'PAY' + (paymentsData.length + 1).toString().padStart(3, '0');
            const newPayment = {
                id: newPaymentId,
                invoiceId: invoiceId,
                customerId: invoice.customerId,
                paymentDate: new Date().toISOString().split('T')[0],
                amount: invoice.totalAmount, // Assuming full payment
                method: 'System (Marked Paid)',
                notes: 'Invoice marked as paid through system.'
            };
            paymentsData.push(newPayment);

            renderInvoicesTable();
            renderPaymentsTable(); // Update payments tab too
            closeModal('viewInvoiceModal');
            alert(`Invoice ${invoiceId} marked as paid! Payment ${newPaymentId} recorded.`);
        } else if (invoice && invoice.balanceDue === 0) {
            alert('This invoice is already fully paid.');
        } else {
            alert('Invoice not found or already paid.');
        }
    }

    function filterInvoices() {
        const searchTerm = document.getElementById('invoiceSearch').value.toLowerCase();
        const statusFilter = document.getElementById('invoiceStatusFilter').value;

        const filteredData = invoicesData.filter(invoice => {
            const customer = customerData.find(c => c.id === invoice.customerId);
            const customerName = customer ? customer.name.toLowerCase() : '';

            const matchesSearch = invoice.id.toLowerCase().includes(searchTerm) ||
                                  customerName.includes(searchTerm) ||
                                  invoice.issueDate.includes(searchTerm);
            const matchesStatus = statusFilter === '' || invoice.status === statusFilter;

            return matchesSearch && matchesStatus;
        });
        renderInvoicesTable(filteredData);
    }

    // --- Payment Functions ---
    recordPaymentBtn.addEventListener('click', openRecordPaymentModal);
    paymentForm.addEventListener('submit', recordPayment);

    function renderPaymentsTable(dataToRender = paymentsData) {
        paymentsTableBody.innerHTML = '';
        if (!Array.isArray(dataToRender) || dataToRender.length === 0) {
            const row = paymentsTableBody.insertRow();
            row.innerHTML = '<td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No payments found.</td>';
            return;
        }
        dataToRender.forEach(payment => {
            const row = paymentsTableBody.insertRow();
            const customer = customerData.find(c => c.id === payment.customerId);
            row.classList.add('hover:bg-gray-50');

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900').textContent = payment.id;
            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500').textContent = payment.invoiceId || 'N/A';
            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500').textContent = customer ? customer.name : 'Unknown';
            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500').textContent = payment.paymentDate;
            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500').textContent = `$${payment.amount.toFixed(2)}`;
            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500').textContent = payment.method;

            const actionsCell = row.insertCell();
            actionsCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-right', 'text-sm', 'font-medium');
            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'View Detail'; // For simplicity, this will just alert for now
            viewBtn.classList.add('text-indigo-600', 'hover:text-indigo-900', 'transition-colors', 'duration-200');
            viewBtn.onclick = () => alert(`Viewing details for Payment ID: ${payment.id}\nAmount: $${payment.amount.toFixed(2)} for Invoice: ${payment.invoiceId || 'N/A'}`);
            actionsCell.appendChild(viewBtn);
        });
    }

    function openRecordPaymentModal(invoiceId = '') {
        paymentForm.reset();
        paymentForInvoiceIdField.value = ''; // Hidden field to link to specific invoice if passed
        paymentInvoiceIdInput.value = invoiceId;
        paymentDateInput.valueAsDate = new Date(); // Set to today's date

        if (invoiceId) {
            paymentInvoiceIdInput.disabled = true; // Make it read-only if specific invoice is passed
            const invoice = invoicesData.find(i => i.id === invoiceId);
            if (invoice) {
                paymentAmountInput.value = invoice.balanceDue > 0 ? invoice.balanceDue.toFixed(2) : invoice.totalAmount.toFixed(2); // Suggest balance due
            }
        } else {
            paymentInvoiceIdInput.disabled = false;
        }
        openModal('recordPaymentModal');
    }

    function recordPayment(event) {
        event.preventDefault();
        const invoiceId = paymentInvoiceIdInput.value || null;
        const amount = parseFloat(paymentAmountInput.value) || 0;
        const method = paymentMethodSelect.value;
        const paymentDate = paymentDateInput.value;

        if (amount <= 0 || !method || !paymentDate) {
            alert('Please enter a valid amount, select a method, and choose a date.');
            return;
        }

        const newPaymentId = 'PAY' + (paymentsData.length + 1).toString().padStart(3, '0');
        const customer = invoiceId ? customerData.find(c => c.id === invoicesData.find(i => i.id === invoiceId)?.customerId) : null;

        const newPayment = {
            id: newPaymentId,
            invoiceId: invoiceId,
            customerId: customer ? customer.id : 'Unknown', // Link to customer if invoice exists
            paymentDate: paymentDate,
            amount: amount,
            method: method,
            notes: 'Recorded manually by vendor.'
        };
        paymentsData.push(newPayment);

        // Update invoice balance if linked
        if (invoiceId) {
            const invoice = invoicesData.find(i => i.id === invoiceId);
            if (invoice) {
                invoice.balanceDue -= amount;
                if (invoice.balanceDue <= 0) {
                    invoice.balanceDue = 0;
                    invoice.status = 'Paid';
                } else if (invoice.balanceDue > 0 && invoice.balanceDue < invoice.totalAmount) {
                    invoice.status = 'Partially Paid';
                }
                renderInvoicesTable(); // Re-render invoices table to show updated status/balance
            }
        }

        renderPaymentsTable();
        closeModal('recordPaymentModal');
        alert(`Payment ${newPaymentId} of $${amount.toFixed(2)} recorded.`);
    }

    function filterPayments() {
        const searchTerm = document.getElementById('paymentSearch').value.toLowerCase();
        const filteredData = paymentsData.filter(payment => {
            const customer = customerData.find(c => c.id === payment.customerId);
            const customerName = customer ? customer.name.toLowerCase() : '';

            const matchesSearch = payment.id.toLowerCase().includes(searchTerm) ||
                                  (payment.invoiceId && payment.invoiceId.toLowerCase().includes(searchTerm)) ||
                                  customerName.includes(searchTerm) ||
                                  payment.method.toLowerCase().includes(searchTerm);
            return matchesSearch;
        });
        renderPaymentsTable(filteredData);
    }


    // --- Quote to Invoice/Booking Conversion ---
    function convertQuoteToBookingAndInvoice(quoteId) {
        const quote = quotesData.find(q => q.id === quoteId);
        if (!quote) {
            alert('Quote not found.');
            return;
        }

        if (quote.status === 'Accepted') {
            alert('This quote has already been accepted and converted.');
            return;
        }

        if (!confirm(`Are you sure you want to ACCEPT Quote ${quote.id} and convert it to a Booking and Invoice?`)) {
            return;
        }

        // 1. Mark Quote as Accepted
        quote.status = 'Accepted';

        // 2. Create a Dummy Booking
        const newBookingId = 'BOOK' + (window.bookingData.length + 1).toString().padStart(3, '0'); // Use window.bookingData
        const dummyBooking = {
            id: newBookingId,
            customerId: quote.customerId,
            equipmentId: quote.items[0] ? quote.items[0].equipmentId : '', // Take first item's equipment
            rentalStartDate: new Date().toISOString().split('T')[0],
            rentalEndDate: new Date(new Date().setDate(new Date().getDate() + (quote.items[0] ? quote.items[0].rentalDays : 0))).toISOString().split('T')[0], // End date based on first item
            deliveryAddress: customerData.find(c => c.id === quote.customerId)?.billingAddress || 'N/A', // Use customer's billing address
            pickupAddress: customerData.find(c => c.id === quote.customerId)?.billingAddress || 'N/A',
            status: 'Confirmed',
            totalPrice: quote.totalAmount,
            bookingNotes: `Generated from Quote ${quote.id}. ${quote.notes || ''}`,
            driverId: '' // Unassigned initially
        };
        window.bookingData.push(dummyBooking); // Push to global bookingData

        // 3. Create an Invoice from the Quote
        const newInvoiceId = 'INV' + (invoicesData.length + 1).toString().padStart(3, '0');
        const invoiceItems = quote.items.map(item => {
            const eq = equipmentData.find(e => e.id === item.equipmentId);
            return {
                description: `${eq ? eq.type + ' (' + eq.size + ')' : 'Equipment'} Rental for ${item.rentalDays} days`,
                amount: item.itemTotalPrice,
                unitPrice: item.unitPrice, // Ensure unitPrice and quantity are included for consistency with global data structure
                quantity: item.rentalDays
            };
        });
        if (quote.deliveryFee > 0) invoiceItems.push({ description: 'Delivery Fee', amount: quote.deliveryFee, unitPrice: quote.deliveryFee, quantity: 1 });
        if (quote.pickupFee > 0) invoiceItems.push({ description: 'Pickup Fee', amount: quote.pickupFee, unitPrice: quote.pickupFee, quantity: 1 });
        if (quote.damageWaiver > 0) invoiceItems.push({ description: 'Damage Waiver', amount: quote.damageWaiver, unitPrice: quote.damageWaiver, quantity: 1 });


        const newInvoice = {
            id: newInvoiceId,
            customerId: quote.customerId,
            issueDate: new Date().toISOString().split('T')[0],
            dueDate: new Date(new Date().setDate(new Date().getDate() + 30)).toISOString().split('T')[0], // 30 days from now
            items: invoiceItems,
            totalAmount: quote.totalAmount,
            balanceDue: quote.totalAmount,
            status: 'Sent',
            linkedQuoteId: quote.id,
            linkedBookingId: newBookingId
        };
        invoicesData.push(newInvoice);


        // Update tables and close modal
        renderQuotesTable();
        renderInvoicesTable();
        closeModal('viewQuoteModal');

        alert(`Quote ${quote.id} Accepted!\n\nBooking ${newBookingId} created.\nInvoice ${newInvoiceId} generated and sent.`);
        console.log("New Booking created:", dummyBooking);
        console.log("New Invoice created:", newInvoice);
    }


    // --- Initial Render ---
    // This will run immediately after the module HTML is injected.
    // Set default date for payment form input
    paymentDateInput.valueAsDate = new Date();
    switchFinanceView('quotes'); // Default to Quotes tab

})(); // End of IIFE
</script>