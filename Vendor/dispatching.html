<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispatching & Route Optimization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom scrollbar for driver columns if needed */
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background-color: #cbd5e0; /* gray-300 */
            border-radius: 4px;
        }
        .overflow-x-auto::-webkit-scrollbar-track {
            background-color: #f7fafc; /* gray-50 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8">

    <script>
        window.bookingData = [
            { id: 'JOB001', customerId: 'CUST001', equipmentId: 'EQ001', rentalStartDate: '2025-07-25', rentalEndDate: '2025-07-25', deliveryAddress: '123 Main St, Anytown', driverId: '', status: 'Pending' },
            { id: 'JOB002', customerId: 'CUST002', equipmentId: 'EQ002', rentalStartDate: '2025-07-25', rentalEndDate: '2025-07-26', deliveryAddress: '456 Oak Ave, Anytown', driverId: 'DRV001', status: 'Confirmed' },
            { id: 'JOB003', customerId: 'CUST003', equipmentId: 'EQ003', rentalStartDate: '2025-07-26', rentalEndDate: '2025-07-26', deliveryAddress: '789 Pine Ln, Anytown', driverId: '', status: 'Pending' },
            { id: 'JOB004', customerId: 'CUST001', equipmentId: 'EQ004', rentalStartDate: '2025-07-26', rentalEndDate: '2025-07-27', deliveryAddress: '321 Elm Rd, Anytown', driverId: 'DRV002', status: 'Confirmed' },
            { id: 'JOB005', customerId: 'CUST004', equipmentId: 'EQ005', rentalStartDate: '2025-07-27', rentalEndDate: '2025-07-27', deliveryAddress: '654 Birch Ct, Anytown', driverId: '', status: 'Pending' },
            { id: 'JOB006', customerId: 'CUST002', equipmentId: 'EQ001', rentalStartDate: '2025-07-28', rentalEndDate: '2025-07-28', deliveryAddress: '987 Cedar Pk, Anytown', driverId: '', status: 'Pending' },
            { id: 'JOB007', customerId: 'CUST005', equipmentId: 'EQ006', rentalStartDate: '2025-07-28', rentalEndDate: '2025-07-29', deliveryAddress: '101 Maple Dr, Anytown', driverId: 'DRV001', status: 'Confirmed' },
        ];

        window.driverData = [
            { id: 'DRV001', name: 'Alice Smith', status: 'Active', assignedVehicle: 'Truck A1' },
            { id: 'DRV002', name: 'Bob Johnson', status: 'Active', assignedVehicle: 'Truck B2' },
            { id: 'DRV003', name: 'Charlie Brown', status: 'Inactive', assignedVehicle: 'Van C3' },
            { id: 'DRV004', name: 'Diana Prince', status: 'Active', assignedVehicle: 'Truck D4' }
        ];

        window.customerData = [
            { id: 'CUST001', name: 'Acme Corp' },
            { id: 'CUST002', name: 'Globex Inc.' },
            { id: 'CUST003', name: 'Weyland-Yutani' },
            { id: 'CUST004', name: 'Stark Industries' },
            { id: 'CUST005', name: 'Oscorp' }
        ];

        window.equipmentData = [
            { id: 'EQ001', type: 'Dumpster', size: '20 Yard' },
            { id: 'EQ002', type: 'Excavator', size: 'Mini' },
            { id: 'EQ003', type: 'Skid Steer', size: 'Compact' },
            { id: 'EQ004', type: 'Generator', size: '50 kW' },
            { id: 'EQ005', type: 'Forklift', size: '5000 lbs' },
            { id: 'EQ006', type: 'Scissor Lift', size: '30 ft' }
        ];
    </script>

    <div class="p-8 bg-white rounded-lg shadow-xl mx-auto max-w-7xl">
        <h2 class="text-3xl font-bold text-gray-900 mb-6">Dispatching & Route Optimization</h2>

        <div class="flex border-b border-gray-200 mb-8 space-x-6">
            <span class="dispatch-tab py-2 px-0 cursor-pointer font-bold text-gray-500 transition-colors duration-300 hover:text-gray-800 border-b-2 border-transparent text-[#EA3A26] border-[#EA3A26]" data-view="board">Driver Board</span>
            <span class="dispatch-tab py-2 px-0 cursor-pointer font-bold text-gray-500 transition-colors duration-300 hover:text-gray-800 border-b-2 border-transparent" data-view="list">Job List</span>
            <span class="dispatch-tab py-2 px-0 cursor-pointer font-bold text-gray-500 transition-colors duration-300 hover:text-gray-800 border-b-2 border-transparent" data-view="map">Map View (Conceptual)</span>
            <span class="dispatch-tab py-2 px-0 cursor-pointer font-bold text-gray-500 transition-colors duration-300 hover:text-gray-800 border-b-2 border-transparent" data-view="calendar">Driver Schedule (Conceptual)</span>
        </div>

        <div id="dispatch-view-board" class="dispatch-content-view">
            <div class="flex flex-col md:flex-row items-start justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 mb-2 md:mb-0">Job Assignment Board</h3>
                <button onclick="simulateRouteOptimization()" class="px-6 py-2 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200 flex items-center gap-2">
                    <i class="fas fa-route"></i> Simulate Route Optimization
                </button>
            </div>
            <div class="flex overflow-x-auto pb-4 -mx-2">
                <div class="flex-none w-80 bg-gray-100 p-4 rounded-lg shadow-md mr-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 border-gray-300">Unassigned Jobs</h3>
                    <div id="unassignedJobsContainer" class="space-y-3 min-h-[200px]">
                        <p class="text-gray-500 italic text-center py-4 text-sm">Loading jobs...</p>
                    </div>
                </div>

                <div id="driverColumnsContainer" class="flex flex-grow overflow-x-auto">
                    <p class="text-gray-500 italic text-center py-4 text-sm w-full">Loading drivers...</p>
                </div>
            </div>
        </div>

        <div id="dispatch-view-list" class="dispatch-content-view hidden">
            <div class="bg-white rounded-lg shadow-md overflow-x-auto p-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 border-gray-300">All Bookings List</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booking ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipment</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Driver</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="dispatchListViewTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="dispatch-view-map" class="dispatch-content-view hidden">
            <div class="bg-white p-8 rounded-lg shadow-md text-center h-full flex flex-col items-center justify-center">
                <i class="fas fa-map-marked-alt text-6xl text-gray-400 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Map View - Intelligent Route Optimization & Real-time Tracking</h3>
                <p class="text-gray-600 max-w-2xl mx-auto mb-6">
                    This is the **live command center** of your dispatch operations. In a real system, powered by Google Maps Platform, it would offer:
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto text-left">
                    <div class="p-4 bg-gray-50 rounded-md shadow-sm">
                        <h4 class="font-semibold text-lg text-blue-700 mb-2">Real-time Tracking & Visibility</h4>
                        <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                            <li><strong>Live Map:</strong> Shows all active drivers, their current locations, and assigned routes.</li>
                            <li><strong>Driver & Job Status:</strong> Color-coded job pins (Red: Unassigned, Yellow: Pending, Blue: En Route, Green: Completed) and driver icons indicating status (On Route, Idle).</li>
                            <li><strong>Real-time Updates:</strong> Driver updates (e.g., "Arrived," "Job Complete") reflected instantly on the map.</li>
                            <li><strong>ETA & Progress:</strong> Track estimated time of arrival to next stop and overall route progress.</li>
                        </ul>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-md shadow-sm">
                        <h4 class="font-semibold text-lg text-blue-700 mb-2">Intelligent Route Optimization</h4>
                        <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                            <li><strong>Multi-stop & Multi-driver Optimization:</strong> Automatically generates the most efficient routes.</li>
                            <li><strong>Constraint Consideration:</strong> Accounts for time windows, vehicle capacity, driver skills, traffic (real-time & historical), and road restrictions.</li>
                            <li><strong>Dynamic Adjustments:</strong> Ability to re-optimize routes on the fly for last-minute changes, new orders, or delays.</li>
                            <li><strong>Geofencing:</strong> Define virtual boundaries for arrival/departure alerts and time tracking at locations.</li>
                            <li><strong>Drag-and-and-Drop:</strong> Visually reassign jobs by dragging pins to different routes (in a truly interactive version).</li>
                        </ul>
                    </div>
                </div>
                <img src="https://via.placeholder.com/800x450/E0E0E0/6C757D?text=Placeholder+Map+View" alt="Map View Placeholder" class="mt-8 rounded-lg shadow-lg border border-gray-200">
                <p class="text-gray-600 text-sm mt-4">
                    (This view would be powered by direct integration with Google Maps Platform APIs - Geocoding, Distance Matrix, Routes API - requiring a backend and billing setup.)
                </p>
            </div>
        </div>

        <div id="dispatch-view-calendar" class="dispatch-content-view hidden">
            <div class="bg-white p-8 rounded-lg shadow-md text-center h-full flex flex-col items-center justify-center">
                <i class="fas fa-calendar-day text-6xl text-gray-400 mb-4"></i>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Driver Schedule / Timeline View (Gantt-style)</h3>
                <p class="text-gray-600 max-w-xl mx-auto mb-6">
                    This view provides a visual timeline for comprehensive scheduling and workload management:
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto text-left">
                    <div class="p-4 bg-gray-50 rounded-md shadow-sm">
                        <h4 class="font-semibold text-lg text-blue-700 mb-2">Detailed Scheduling</h4>
                        <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                            <li><strong>Visual Timeline:</strong> Each driver as a row, showing assigned routes, breaks, and availability across a time axis.</li>
                            <li><strong>Workload Balancing:</strong> Easily identify over- or under-utilized drivers.</li>
                            <li><strong>Conflict Detection:</strong> Spot scheduling conflicts or overlapping jobs.</li>
                        </ul>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-md shadow-sm">
                        <h4 class="font-semibold text-lg text-blue-700 mb-2">Availability & Compliance</h4>
                        <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                            <li><strong>Driver Availability:</strong> Visually manage driver shifts, time-off requests, and current availability status.</li>
                            <li><strong>Hours of Service (HOS) Tracking:</strong> Monitor compliance with regulations to prevent fatigue and ensure legal operation.</li>
                        </ul>
                    </div>
                </div>
                <img src="https://via.placeholder.com/800x450/E0E0E0/6C757D?text=Placeholder+Gantt+Chart" alt="Gantt Chart Placeholder" class="mt-8 rounded-lg shadow-lg border border-gray-200">
                <p class="text-gray-600 text-sm mt-4">
                    (This feature is typically built with specialized Gantt chart libraries or robust frontend frameworks for complex interactive timelines.)
                </p>
            </div>
        </div>

        <div id="jobActionModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 max-w-md relative">
                <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" onclick="closeModal('jobActionModal')">&times;</button>
                <h3 id="jobActionModalTitle" class="text-2xl font-bold text-[#EA3A26] mb-6 border-b pb-3 border-gray-200">Assign Job</h3>
                <div class="space-y-4">
                    <p><strong>Booking:</strong> <span id="modalBookingInfo"></span></p>
                    <p><strong>Current Driver:</strong> <span id="modalCurrentDriver">Unassigned</span></p>

                    <div id="assignDriverField">
                        <label for="assignDriverSelect" class="block text-sm font-medium text-gray-700 mb-1">Assign to Driver:</label>
                        <select id="assignDriverSelect"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                            <option value="">Select Driver</option>
                        </select>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md font-semibold hover:bg-gray-400 transition-colors duration-200" onclick="closeModal('jobActionModal')">Cancel</button>
                        <button type="button" id="confirmAssignBtn" class="px-6 py-2 bg-[#EA3A26] text-white rounded-md font-semibold hover:bg-[#F54F1D] transition-colors duration-200" onclick="confirmJobAssignment()">Confirm Assignment</button>
                        <button type="button" id="unassignBtn" class="px-6 py-2 bg-red-600 text-white rounded-md font-semibold hover:bg-red-700 transition-colors duration-200 hidden" onclick="unassignJob()">Unassign Job</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Modal Functions (can be moved to a separate utility file if preferred)
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        (function() { // Wrap in IIFE for scope
            // Access global data directly from the window object
            let bookingData = window.bookingData; // Using 'let' because its driverId property is modified
            const driverData = window.driverData;
            const customerData = window.customerData;
            const equipmentData = window.equipmentData;

            let currentJobToAssign = null; // Stores the booking ID being acted upon in the modal

            // Get elements
            const dispatchTabs = document.querySelectorAll('.dispatch-tab');
            const dispatchContentViews = document.querySelectorAll('.dispatch-content-view');

            // Driver Board View elements
            const unassignedJobsContainer = document.getElementById('unassignedJobsContainer');
            const driverColumnsContainer = document.getElementById('driverColumnsContainer');

            // List View elements
            const dispatchListViewTableBody = document.getElementById('dispatchListViewTableBody');

            // Job Action Modal elements
            const jobActionModal = document.getElementById('jobActionModal');
            const jobActionModalTitle = document.getElementById('jobActionModalTitle');
            const modalBookingInfo = document.getElementById('modalBookingInfo');
            const modalCurrentDriver = document.getElementById('modalCurrentDriver');
            const assignDriverField = document.getElementById('assignDriverField');
            const assignDriverSelect = document.getElementById('assignDriverSelect');
            const confirmAssignBtn = document.getElementById('confirmAssignBtn');
            const unassignBtn = document.getElementById('unassignBtn');

            // --- View Switching Logic ---
            function switchDispatchView(viewName) {
                // Hide all content views
                dispatchContentViews.forEach(view => view.classList.add('hidden'));
                // Show the selected view
                document.getElementById(`dispatch-view-${viewName}`).classList.remove('hidden');

                // Update active tab styling
                dispatchTabs.forEach(tab => {
                    tab.classList.remove('text-[#EA3A26]', 'border-[#EA3A26]');
                    tab.classList.add('text-gray-500', 'border-transparent');
                });
                const activeTab = Array.from(dispatchTabs).find(tab => tab.dataset.view === viewName);
                if (activeTab) {
                    activeTab.classList.add('text-[#EA3A26]', 'border-[#EA3A26]');
                    activeTab.classList.remove('text-gray-500', 'border-transparent');
                }

                // Render content specific to the active view
                if (viewName === 'board') {
                    renderDriverBoardView();
                } else if (viewName === 'list') {
                    renderListView();
                }
                // No specific rendering needed for 'map' and 'calendar' as they are conceptual placeholders.
            }

            // --- Driver Board View (Simulated Drag & Drop via Modals) ---
            function renderDriverBoardView() {
                unassignedJobsContainer.innerHTML = ''; // Clear previous content
                driverColumnsContainer.innerHTML = ''; // Clear previous content

                // Render Unassigned Jobs
                const unassignedBookings = bookingData.filter(b => !b.driverId);
                if (unassignedBookings.length === 0) {
                    unassignedJobsContainer.innerHTML = '<p class="text-gray-500 italic text-center py-4">All jobs assigned!</p>';
                } else {
                    unassignedBookings.forEach(booking => {
                        unassignedJobsContainer.appendChild(createJobCard(booking));
                    });
                }

                // Render Driver Columns
                const activeDrivers = driverData.filter(d => d.status === 'Active');
                if (activeDrivers.length === 0) {
                    driverColumnsContainer.innerHTML = '<p class="text-gray-500 italic text-center py-4 w-full">No active drivers available for assignment.</p>';
                } else {
                    activeDrivers.forEach(driver => {
                        const driverColumn = document.createElement('div');
                        driverColumn.classList.add('flex-none', 'w-80', 'bg-gray-100', 'p-4', 'rounded-lg', 'shadow-md', 'mr-4');
                        driverColumn.innerHTML = `
                            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 border-gray-300">
                                ${driver.name} <span class="text-sm text-gray-500">(${driver.assignedVehicle || 'No Vehicle'})</span>
                            </h3>
                            <div id="driver-jobs-${driver.id}" class="space-y-3 min-h-[150px]">
                            </div>
                        `;
                        driverColumnsContainer.appendChild(driverColumn);

                        const assignedJobsForDriver = bookingData.filter(b => b.driverId === driver.id);
                        const driverJobsContainer = document.getElementById(`driver-jobs-${driver.id}`);
                        if (assignedJobsForDriver.length === 0) {
                            driverJobsContainer.innerHTML = '<p class="text-gray-500 italic text-center py-4 text-sm">No assigned jobs.</p>';
                        } else {
                            assignedJobsForDriver.forEach(booking => {
                                driverJobsContainer.appendChild(createJobCard(booking));
                            });
                        }
                    });
                }
            }

            function createJobCard(booking) {
                const customer = customerData.find(c => c.id === booking.customerId);
                const equipment = equipmentData.find(e => e.id === booking.equipmentId);

                const card = document.createElement('div');
                card.classList.add('bg-white', 'p-3', 'rounded-md', 'shadow-sm', 'border', 'border-gray-200', 'cursor-pointer', 'hover:shadow-md', 'transition-shadow');
                card.innerHTML = `
                    <p class="font-semibold text-gray-800">${booking.id} - ${customer ? customer.name : 'Unknown Customer'}</p>
                    <p class="text-sm text-gray-600">${equipment ? `${equipment.type} (${equipment.size})` : 'Unknown Equipment'}</p>
                    <p class="text-xs text-gray-500">Delivery: ${booking.rentalStartDate} to ${booking.deliveryAddress}</p>
                    <p class="text-xs ${booking.status === 'Pending' ? 'text-[#FF8600]' : booking.status === 'Confirmed' ? 'text-green-600' : 'text-gray-500'}">Status: ${booking.status}</p>
                `;
                card.onclick = () => openJobActionModal(booking.id);
                return card;
            }

            // --- Job Action Modal Functions ---
            function openJobActionModal(bookingId) {
                currentJobToAssign = bookingId;
                const booking = bookingData.find(b => b.id === bookingId);
                if (!booking) return;

                const customer = customerData.find(c => c.id === booking.customerId);
                const equipment = equipmentData.find(e => e.id === booking.equipmentId);
                const currentDriver = driverData.find(d => d.id === booking.driverId);

                modalBookingInfo.textContent = `${booking.id} - ${customer ? customer.name : 'Unknown Customer'} - ${equipment ? equipment.type : 'Unknown Equipment'}`;
                modalCurrentDriver.textContent = currentDriver ? currentDriver.name : 'Unassigned';

                // Populate driver dropdown for assignment
                assignDriverSelect.innerHTML = '<option value="">Select Driver</option>'; // Clear previous options
                driverData.filter(d => d.status === 'Active').forEach(driver => { // Only active drivers can be assigned
                    const option = document.createElement('option');
                    option.value = driver.id;
                    option.textContent = driver.name;
                    if (currentDriver && driver.id === currentDriver.id) {
                        option.selected = true; // Pre-select current driver
                    }
                    assignDriverSelect.appendChild(option);
                });

                // Configure modal buttons based on current assignment status
                if (booking.driverId) {
                    jobActionModalTitle.textContent = 'Reassign/Unassign Job';
                    confirmAssignBtn.textContent = 'Change Assignment';
                    unassignBtn.classList.remove('hidden'); // Show unassign button if driver is assigned
                    assignDriverField.classList.remove('hidden'); // Ensure driver selection is visible
                } else {
                    jobActionModalTitle.textContent = 'Assign Job';
                    confirmAssignBtn.textContent = 'Assign Job';
                    unassignBtn.classList.add('hidden'); // Hide unassign button if no driver is assigned
                    assignDriverField.classList.remove('hidden'); // Ensure driver selection is visible
                }

                openModal('jobActionModal');
            }

            function confirmJobAssignment() {
                const booking = bookingData.find(b => b.id === currentJobToAssign);
                const selectedDriverId = assignDriverSelect.value;

                if (booking) {
                    if (selectedDriverId) {
                        booking.driverId = selectedDriverId;
                        // Optionally update status to 'Confirmed' if assigned
                        booking.status = 'Confirmed';
                        alert(`Booking ${booking.id} successfully assigned to ${driverData.find(d => d.id === selectedDriverId).name}.`);
                    } else {
                        // If no driver selected when trying to assign/change, alert and don't proceed
                        alert('Please select a driver or cancel the assignment.');
                        return;
                    }
                }
                renderDriverBoardView(); // Re-render the board to reflect changes
                renderListView(); // Re-render the list view as well to keep it updated
                closeModal('jobActionModal');
            }

            function unassignJob() {
                if (confirm(`Are you sure you want to unassign Booking ${currentJobToAssign}?`)) {
                    const booking = bookingData.find(b => b.id === currentJobToAssign);
                    if (booking) {
                        booking.driverId = ''; // Set to unassigned
                        booking.status = 'Pending'; // Revert status to pending
                        alert(`Booking ${booking.id} unassigned and status set to Pending.`);
                    }
                    renderDriverBoardView(); // Re-render the board to reflect changes
                    renderListView(); // Re-render the list view as well to keep it updated
                    closeModal('jobActionModal');
                }
            }

            // --- Simulate Route Optimization ---
            window.simulateRouteOptimization = function() { // Make global for onclick
                const unassignedCount = bookingData.filter(b => !b.driverId).length;
                const activeDriversCount = driverData.filter(d => d.status === 'Active').length;

                let simulationMessage = `Simulating Route Optimization Process (Google Maps API Integration):\n\n`;
                simulationMessage += `Step 1: Gathering ${unassignedCount} unassigned jobs, ${activeDriversCount} active drivers, time windows, and vehicle capacities.\n`;
                simulationMessage += `Step 2: Using Google Maps Platform APIs (Geocoding, Distance Matrix) to calculate precise distances and travel times between all points, considering real-time traffic.\n`;
                simulationMessage += `Step 3: Solving the Vehicle Routing Problem (VRP) algorithm to determine the most efficient routes that minimize travel time, respect time windows, and balance workload.\n`;
                simulationMessage += `Step 4: Optimized routes are generated and displayed on the Map View for dispatcher review. They can then be dispatched to drivers' mobile apps.\n\n`;
                simulationMessage += `(Note: This is a simulation. Actual optimization would happen in a backend service connected to Google Maps APIs.)`;

                alert(simulationMessage);
                console.log(simulationMessage);
            };


            // --- List View Rendering ---
            function renderListView() {
                dispatchListViewTableBody.innerHTML = ''; // Clear previous content
                if (bookingData.length === 0) {
                    const row = dispatchListViewTableBody.insertRow();
                    row.innerHTML = '<td colspan="8" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No bookings found.</td>';
                    return;
                }

                bookingData.forEach(booking => {
                    const customer = customerData.find(c => c.id === booking.customerId);
                    const equipment = equipmentData.find(e => e.id === booking.equipmentId);
                    const driver = driverData.find(d => d.id === booking.driverId);

                    const row = dispatchListViewTableBody.insertRow();
                    row.classList.add('hover:bg-gray-50');

                    row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900');
                    row.cells[0].textContent = booking.id;

                    row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
                    row.cells[1].textContent = customer ? customer.name : booking.customerId;

                    row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
                    row.cells[2].textContent = equipment ? `${equipment.type} (${equipment.size})` : booking.equipmentId;

                    row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
                    row.cells[3].textContent = booking.rentalStartDate;

                    row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
                    row.cells[4].textContent = booking.rentalEndDate;

                    row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
                    row.cells[5].textContent = driver ? driver.name : 'Unassigned';

                    row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
                    row.cells[6].textContent = booking.status;

                    const actionsCell = row.insertCell();
                    actionsCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-right', 'text-sm', 'font-medium');
                    const viewBtn = document.createElement('button');
                    viewBtn.textContent = 'View Job';
                    viewBtn.classList.add('text-indigo-600', 'hover:text-indigo-900', 'transition-colors', 'duration-200');
                    viewBtn.onclick = () => alert(`Viewing details for Booking ID: ${booking.id}\n(In a real app, this would open the booking details modal from the Bookings module.)`);
                    actionsCell.appendChild(viewBtn);
                });
            }

            // --- Initial Load ---
            document.addEventListener('DOMContentLoaded', () => {
                // Attach event listeners for tabs
                dispatchTabs.forEach(tab => {
                    tab.addEventListener('click', (event) => {
                        switchDispatchView(event.target.dataset.view);
                    });
                });

                // Set initial view to Driver Board
                switchDispatchView('board');
            });

        })(); // End of IIFE
    </script>

</body>
</html>