<div class="p-8">
    <h2 class="text-3xl font-bold text-gray-900 mb-6">Booking & Scheduling</h2>

    <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
        <button id="addBookingBtn" class="px-6 py-3 bg-[#EA3A26] text-white rounded-md font-semibold hover:bg-[#F54F1D] transition-colors duration-200 flex items-center gap-2">
            <i class="fas fa-plus-circle"></i> Create New Booking
        </button>
        <div class="flex flex-wrap items-center gap-4">
            <input type="text" id="bookingSearch" placeholder="Search by ID, Customer..." onkeyup="filterBookings()"
                   class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#EA3A26] w-full md:w-auto">
            <select id="bookingStatusFilter" onchange="filterBookings()"
                    class="px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#EA3A26] w-full md:w-auto">
                <option value="">All Statuses</option>
                <option value="Pending">Pending</option>
                <option value="Confirmed">Confirmed</option>
                <option value="Delivered">Delivered</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
            </select>
            <input type="date" id="bookingDateFilter" onchange="filterBookings()"
                   class="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#EA3A26] w-full md:w-auto">
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-md overflow-x-auto mb-8">
        <table class="min-w-full divide-y divide-gray-200" id="bookingTable">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booking ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipment</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <!-- Booking data will be rendered here -->
            </tbody>
        </table>
    </div>

    <!-- Create/Edit Booking Modal -->
    <div id="bookingModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 max-w-3xl relative max-h-[90vh] overflow-y-auto">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" onclick="closeModal('bookingModal')">&times;</button>
            <h3 id="modalTitle" class="text-2xl font-bold text-[#EA3A26] mb-6 border-b pb-3 border-gray-200">Create New Booking</h3>
            <form id="bookingForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="bookingId">

                <div class="col-span-1 md:col-span-2">
                    <label for="customerIdSelect" class="block text-sm font-medium text-gray-700 mb-1">Customer:</label>
                    <select id="customerIdSelect" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                        <option value="">Select Customer</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div class="col-span-1 md:col-span-2">
                    <label for="equipmentIdSelect" class="block text-sm font-medium text-gray-700 mb-1">Equipment:</label>
                    <select id="equipmentIdSelect" required onchange="handleEquipmentSelection()"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                        <option value="">Select Equipment</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <div>
                    <label for="rentalStartDate" class="block text-sm font-medium text-gray-700 mb-1">Rental Start Date:</label>
                    <input type="date" id="rentalStartDate" required onchange="calculatePrice()"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                </div>

                <div>
                    <label for="rentalEndDate" class="block text-sm font-medium text-gray-700 mb-1">Rental End Date:</label>
                    <input type="date" id="rentalEndDate" required onchange="calculatePrice()"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                </div>

                <div class="col-span-1 md:col-span-2">
                    <label for="deliveryAddress" class="block text-sm font-medium text-gray-700 mb-1">Delivery Address:</label>
                    <input type="text" id="deliveryAddress" placeholder="123 Main St, Anytown" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                </div>

                <div class="col-span-1 md:col-span-2">
                    <label for="pickupAddress" class="block text-sm font-medium text-gray-700 mb-1">Pickup Address (if different):</label>
                    <input type="text" id="pickupAddress" placeholder="Same as delivery if left blank"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                </div>

                <!-- Type-Specific Booking Fields -->
                <div id="dumpsterBookingFields" class="col-span-1 md:col-span-2 border-t border-gray-200 pt-4 mt-4 hidden">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Dumpster Specific Details</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="estimatedTonnage" class="block text-sm font-medium text-gray-700 mb-1">Estimated Tonnage:</label>
                            <input type="number" id="estimatedTonnage" min="0" step="0.1" onchange="calculatePrice()"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label for="prohibitedMaterialsAck" class="block text-sm font-medium text-gray-700 mb-1">Prohibited Materials Acknowledgment:</label>
                            <textarea id="prohibitedMaterialsAck" rows="2" placeholder="Acknowledged prohibited items: Tires, Batteries..."
                                      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26] resize-y"></textarea>
                        </div>
                    </div>
                </div>

                <div id="toiletBookingFields" class="col-span-1 md:col-span-2 border-t border-gray-200 pt-4 mt-4 hidden">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Temporary Toilet Specific Details</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="requestedServiceFreq" class="block text-sm font-medium text-gray-700 mb-1">Requested Service Frequency:</label>
                            <select id="requestedServiceFreq" onchange="calculatePrice()"
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                                <option value="Weekly">Weekly</option>
                                <option value="Bi-weekly">Bi-weekly</option>
                                <option value="Event-specific">Event-specific</option>
                            </select>
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label for="toiletSpecialRequests" class="block text-sm font-medium text-gray-700 mb-1">Special Requests:</label>
                            <textarea id="toiletSpecialRequests" rows="2" placeholder="e.g., specific placement, extra supplies"
                                      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26] resize-y"></textarea>
                        </div>
                    </div>
                </div>

                <div id="containerBookingFields" class="col-span-1 md:col-span-2 border-t border-gray-200 pt-4 mt-4 hidden">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">Storage Container Specific Details</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1 md:col-span-2">
                            <label for="containerPlacementNotes" class="block text-sm font-medium text-gray-700 mb-1">Placement Notes:</label>
                            <textarea id="containerPlacementNotes" rows="2" placeholder="e.g., place on concrete pad, clear path needed"
                                      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26] resize-y"></textarea>
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label for="containerSecurityAccess" class="block text-sm font-medium text-gray-700 mb-1">Security/Access Instructions:</label>
                            <textarea id="containerSecurityAccess" rows="2" placeholder="e.g., gate code 1234, call prior to arrival"
                                      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26] resize-y"></textarea>
                        </div>
                    </div>
                </div>
                <!-- End Type-Specific Booking Fields -->

                <div class="col-span-1 md:col-span-2">
                    <label for="bookingStatus" class="block text-sm font-medium text-gray-700 mb-1">Status:</label>
                    <select id="bookingStatus" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                        <option value="Pending">Pending</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Delivered">Delivered</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>

                <div class="col-span-1 md:col-span-2">
                    <label for="totalPrice" class="block text-sm font-medium text-gray-700 mb-1">Total Price ($):</label>
                    <input type="number" id="totalPrice" min="0" step="0.01" placeholder="Calculated automatically" readonly
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 text-gray-700">
                </div>

                <div class="col-span-1 md:col-span-2">
                    <label for="bookingNotes" class="block text-sm font-medium text-gray-700 mb-1">Booking Notes (General):</label>
                    <textarea id="bookingNotes" rows="3" placeholder="Any general instructions for this booking."
                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26] resize-y"></textarea>
                </div>

                <div class="col-span-1 md:col-span-2 flex justify-end gap-3 mt-6">
                    <button type="button" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md font-semibold hover:bg-gray-400 transition-colors duration-200" onclick="closeModal('bookingModal')">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-[#EA3A26] text-white rounded-md font-semibold hover:bg-[#F54F1D] transition-colors duration-200">Save Booking</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Booking Detail Modal -->
    <div id="viewBookingModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 max-w-3xl relative max-h-[90vh] overflow-y-auto">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" onclick="closeModal('viewBookingModal')">&times;</button>
            <h3 class="text-2xl font-bold text-[#EA3A26] mb-6 border-b pb-3 border-gray-200">Booking Details: <span id="detailBookingId"></span></h3>
            <div class="space-y-4 text-gray-700">
                <div class="bg-gray-50 p-4 rounded-md shadow-sm">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2 border-b border-dashed border-gray-300 pb-2">Booking Information</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <p><strong>Customer:</strong> <span id="detailCustomerName"></span> (<span id="detailCustomerId"></span>)</p>
                        <p><strong>Equipment:</strong> <span id="detailEquipmentDisplay"></span> (<span id="detailEquipmentId"></span>)</p>
                        <p><strong>Start Date:</strong> <span id="detailRentalStartDate"></span></p>
                        <p><strong>End Date:</strong> <span id="detailRentalEndDate"></span></p>
                        <p class="col-span-1 md:col-span-2"><strong>Delivery Address:</strong> <span id="detailDeliveryAddress"></span></p>
                        <p class="col-span-1 md:col-span-2"><strong>Pickup Address:</strong> <span id="detailPickupAddress"></span></p>
                        <p><strong>Status:</strong> <span id="detailBookingStatus" class="px-3 py-1 rounded-full text-xs font-bold uppercase text-white"></span></p>
                        <p><strong>Total Price:</strong> $<span id="detailTotalPriceDisplay"></span></p>
                    </div>
                </div>

                <!-- Type-Specific Booking Details for View Modal -->
                <div id="detailDumpsterBookingFields" class="bg-gray-50 p-4 rounded-md shadow-sm hidden">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2 border-b border-dashed border-gray-300 pb-2">Dumpster Booking Specifics</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <p><strong>Estimated Tonnage:</strong> <span id="detailEstimatedTonnage"></span> tons</p>
                        <p class="col-span-1 md:col-span-2"><strong>Prohibited Materials Ack:</strong> <span id="detailProhibitedMaterialsAck"></span></p>
                    </div>
                </div>

                <div id="detailToiletBookingFields" class="bg-gray-50 p-4 rounded-md shadow-sm hidden">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2 border-b border-dashed border-gray-300 pb-2">Temporary Toilet Booking Specifics</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <p><strong>Requested Service Freq:</strong> <span id="detailRequestedServiceFreq"></span></p>
                        <p class="col-span-1 md:col-span-2"><strong>Special Requests:</strong> <span id="detailToiletSpecialRequests"></span></p>
                    </div>
                </div>

                <div id="detailContainerBookingFields" class="bg-gray-50 p-4 rounded-md shadow-sm hidden">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2 border-b border-dashed border-gray-300 pb-2">Storage Container Booking Specifics</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <p class="col-span-1 md:col-span-2"><strong>Placement Notes:</strong> <span id="detailContainerPlacementNotes"></span></p>
                        <p class="col-span-1 md:col-span-2"><strong>Security/Access:</strong> <span id="detailContainerSecurityAccess"></span></p>
                    </div>
                </div>
                <!-- End Type-Specific Booking Details for View Modal -->

                <div class="bg-gray-50 p-4 rounded-md shadow-sm hidden" id="detailBookingNotesGroup">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2 border-b border-dashed border-gray-300 pb-2">Booking Notes (General)</h4>
                    <p><span id="detailBookingNotes"></span></p>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md font-semibold hover:bg-gray-400 transition-colors duration-200" onclick="closeModal('viewBookingModal')">Close</button>
                <button type="button" class="px-6 py-2 bg-[#EA3A26] text-white rounded-md font-semibold hover:bg-[#F54F1D] transition-colors duration-200" id="editFromDetailBtn">Edit Booking</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Ensure window.customerData and window.equipmentData exist from other modules
    if (typeof window.customerData === 'undefined' || !Array.isArray(window.customerData)) {
        console.warn("customerData not found, initializing fallback dummy data.");
        window.customerData = [
            { id: 'CUST001', name: 'Alice Smith', company: 'ABC Construction' },
            { id: 'CUST002', name: 'Bob Johnson', company: '' },
        ];
    }
    if (typeof window.equipmentData === 'undefined' || !Array.isArray(window.equipmentData)) {
        console.warn("equipmentData not found, initializing fallback dummy data.");
        window.equipmentData = [
            { id: 'EQ001', type: 'Dumpster', size: '20-yard', baseDailyRate: 150, deliveryFee: 75, pickupFee: 75, damageWaiverCost: 25, overagePerTonFee: 75, disposalRatePerTon: 50, maxTonnage: 3 },
            { id: 'EQ002', type: 'Temporary Toilet', size: 'Standard', baseDailyRate: 25, deliveryFee: 50, pickupFee: 50, damageWaiverCost: 10, serviceFrequency: 'Weekly' },
            { id: 'EQ003', type: 'Storage Container', size: '40ft', baseDailyRate: 90, deliveryFee: 100, pickupFee: 100, damageWaiverCost: 30 },
        ];
    }

    // Ensure window.bookingData exists and is an array, otherwise initialize it.
    if (typeof window.bookingData === 'undefined' || !Array.isArray(window.bookingData)) {
        window.bookingData = [
            {
                id: 'BOOK001',
                customerId: 'CUST001',
                equipmentId: 'EQ001', // Dumpster
                rentalStartDate: '2025-07-25',
                rentalEndDate: '2025-07-30',
                deliveryAddress: '123 Main St, Springfield, IL',
                pickupAddress: '123 Main St, Springfield, IL',
                status: 'Confirmed',
                totalPrice: 750.00,
                bookingNotes: 'Customer prefers early morning delivery.',
                estimatedTonnage: 2.5,
                prohibitedMaterialsAck: 'Acknowledged: Tires, Batteries',
                driverId: 'DRV001' // Assigned to Michael Scott
            },
            {
                id: 'BOOK002',
                customerId: 'CUST002',
                equipmentId: 'EQ002', // Temporary Toilet
                rentalStartDate: '2025-08-01',
                rentalEndDate: '2025-08-29', // 4 weeks
                deliveryAddress: '789 Oak Ave, Lincoln, NE',
                pickupAddress: '789 Oak Ave, Lincoln, NE',
                status: 'Pending',
                totalPrice: 100.00,
                bookingNotes: 'New residential client, confirm access before delivery.',
                requestedServiceFreq: 'Weekly',
                toiletSpecialRequests: 'Place behind garage.',
                driverId: '' // Unassigned
            },
            {
                id: 'BOOK003',
                customerId: 'CUST001',
                equipmentId: 'EQ003', // Storage Container
                rentalStartDate: '2025-07-20',
                rentalEndDate: '2025-08-20',
                deliveryAddress: '456 Elm St, Springfield, IL',
                pickupAddress: '456 Elm St, Springfield, IL',
                status: 'Delivered',
                totalPrice: 2700.00,
                bookingNotes: 'Long-term storage container for new project.',
                containerPlacementNotes: 'Needs to be on concrete slab, path is narrow.',
                containerSecurityAccess: 'Gate code: 7890, call 1hr prior.',
                driverId: 'DRV002' // Assigned to Dwight Schrute
            }
        ];
    }

    let bookingData = window.bookingData;
    let customerData = window.customerData; // Reference global customer data
    let equipmentData = window.equipmentData; // Reference global equipment data

    let currentBookingId = null;

    // Get elements
    const bookingTableBody = document.querySelector('#bookingTable tbody');
    const addBookingBtn = document.getElementById('addBookingBtn');
    const bookingModal = document.getElementById('bookingModal');
    const viewBookingModal = document.getElementById('viewBookingModal');
    const modalTitle = document.getElementById('modalTitle');
    const bookingForm = document.getElementById('bookingForm');
    const bookingIdField = document.getElementById('bookingId');

    const customerIdSelect = document.getElementById('customerIdSelect');
    const equipmentIdSelect = document.getElementById('equipmentIdSelect');
    const rentalStartDateInput = document.getElementById('rentalStartDate');
    const rentalEndDateInput = document.getElementById('rentalEndDate');
    const totalPriceInput = document.getElementById('totalPrice');

    // Type-specific booking fields (form)
    const dumpsterBookingFields = document.getElementById('dumpsterBookingFields');
    const estimatedTonnageInput = document.getElementById('estimatedTonnage');
    const prohibitedMaterialsAckInput = document.getElementById('prohibitedMaterialsAck');

    const toiletBookingFields = document.getElementById('toiletBookingFields');
    const requestedServiceFreqSelect = document.getElementById('requestedServiceFreq');
    const toiletSpecialRequestsInput = document.getElementById('toiletSpecialRequests');

    const containerBookingFields = document.getElementById('containerBookingFields');
    const containerPlacementNotesInput = document.getElementById('containerPlacementNotes');
    const containerSecurityAccessInput = document.getElementById('containerSecurityAccess');


    // Detail view elements
    const detailBookingId = document.getElementById('detailBookingId');
    const detailCustomerName = document.getElementById('detailCustomerName');
    const detailCustomerId = document.getElementById('detailCustomerId');
    const detailEquipmentDisplay = document.getElementById('detailEquipmentDisplay');
    const detailEquipmentId = document.getElementById('detailEquipmentId');
    const detailRentalStartDate = document.getElementById('detailRentalStartDate');
    const detailRentalEndDate = document.getElementById('detailRentalEndDate');
    const detailDeliveryAddress = document.getElementById('detailDeliveryAddress');
    const detailPickupAddress = document.getElementById('detailPickupAddress');
    const detailBookingStatus = document.getElementById('detailBookingStatus');
    const detailTotalPriceDisplay = document.getElementById('detailTotalPriceDisplay');
    const detailBookingNotes = document.getElementById('detailBookingNotes');
    const detailBookingNotesGroup = document.getElementById('detailBookingNotesGroup');

    // Type-specific booking details (view modal)
    const detailDumpsterBookingFields = document.getElementById('detailDumpsterBookingFields');
    const detailEstimatedTonnage = document.getElementById('detailEstimatedTonnage');
    const detailProhibitedMaterialsAck = document.getElementById('detailProhibitedMaterialsAck');

    const detailToiletBookingFields = document.getElementById('detailToiletBookingFields');
    const detailRequestedServiceFreq = document.getElementById('detailRequestedServiceFreq');
    const detailToiletSpecialRequests = document.getElementById('detailToiletSpecialRequests');

    const detailContainerBookingFields = document.getElementById('detailContainerBookingFields');
    const detailContainerPlacementNotes = document.getElementById('detailContainerPlacementNotes');
    const detailContainerSecurityAccess = document.getElementById('detailContainerSecurityAccess');


    const editFromDetailBtn = document.getElementById('editFromDetailBtn');

    // Event Listeners
    addBookingBtn.addEventListener('click', () => openAddModal());
    bookingForm.addEventListener('submit', (e) => saveBooking(e));
    editFromDetailBtn.addEventListener('click', () => {
        closeModal('viewBookingModal');
        openEditModal(currentBookingId);
    });
    // Add listeners for price calculation
    equipmentIdSelect.addEventListener('change', calculatePrice);
    rentalStartDateInput.addEventListener('change', calculatePrice);
    rentalEndDateInput.addEventListener('change', calculatePrice);


    // --- Modal Functions ---
    function openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        if (modalId === 'bookingModal') {
            bookingForm.reset();
            currentBookingId = null;
            // Hide all type-specific fields on modal close
            hideAllTypeSpecificBookingFields();
        }
    }

    // --- Populate Dropdowns ---
    function populateDropdowns() {
        // Populate Customer Select
        customerIdSelect.innerHTML = '<option value="">Select Customer</option>';
        if (Array.isArray(customerData)) {
            customerData.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} (${customer.company || 'Residential'})`;
                customerIdSelect.appendChild(option);
            });
        }

        // Populate Equipment Select (Only available equipment)
        equipmentIdSelect.innerHTML = '<option value="">Select Equipment</option>';
        if (Array.isArray(equipmentData)) {
            // Filter only 'Available' equipment for new bookings
            // For editing, allow the currently booked equipment to be selected even if its status is not 'Available'
            const availableEquipment = equipmentData.filter(eq => eq.status === 'Available' || eq.id === currentSelectedEquipmentIdForEdit); 
            availableEquipment.forEach(equipment => {
                const option = document.createElement('option');
                option.value = equipment.id;
                option.textContent = `${equipment.type} - ${equipment.size} (ID: ${equipment.id})`;
                equipmentIdSelect.appendChild(option);
            });
        }
    }

    // --- Dynamic Type-Specific Fields ---
    let currentSelectedEquipmentIdForEdit = null; // To keep track for edit modal

    function hideAllTypeSpecificBookingFields() {
        dumpsterBookingFields.classList.add('hidden');
        toiletBookingFields.classList.add('hidden');
        containerBookingFields.classList.add('hidden');

        // Reset values of type-specific fields when hidden
        estimatedTonnageInput.value = '';
        prohibitedMaterialsAckInput.value = '';
        requestedServiceFreqSelect.value = 'Weekly';
        toiletSpecialRequestsInput.value = '';
        containerPlacementNotesInput.value = '';
        containerSecurityAccessInput.value = '';
    }

    function handleEquipmentSelection() {
        hideAllTypeSpecificBookingFields(); // Hide all first
        calculatePrice(); // Recalculate price whenever equipment selection changes

        const selectedEquipmentId = equipmentIdSelect.value;
        const selectedEquipment = equipmentData.find(eq => eq.id === selectedEquipmentId);

        if (selectedEquipment) {
            if (selectedEquipment.type === 'Dumpster') {
                dumpsterBookingFields.classList.remove('hidden');
            } else if (selectedEquipment.type === 'Temporary Toilet') {
                toiletBookingFields.classList.remove('hidden');
            } else if (selectedEquipment.type === 'Storage Container') {
                containerBookingFields.classList.remove('hidden');
            }
        }
    }

    // --- Price Calculation Logic ---
    function calculatePrice() {
        const selectedEquipmentId = equipmentIdSelect.value;
        const startDate = rentalStartDateInput.value;
        const endDate = rentalEndDateInput.value;
        
        let calculatedPrice = 0;

        const selectedEquipment = equipmentData.find(eq => eq.id === selectedEquipmentId);

        if (selectedEquipment && startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const timeDiff = end.getTime() - start.getTime();
            const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1; // +1 to include both start and end day

            if (dayDiff > 0 && selectedEquipment.baseDailyRate) {
                calculatedPrice = selectedEquipment.baseDailyRate * dayDiff;

                // Add flat fees (delivery, pickup, damage waiver)
                calculatedPrice += (selectedEquipment.deliveryFee || 0);
                calculatedPrice += (selectedEquipment.pickupFee || 0);
                calculatedPrice += (selectedEquipment.damageWaiverCost || 0);

                // Add type-specific pricing (dummy for now)
                if (selectedEquipment.type === 'Dumpster') {
                    // For demo, assume estimated tonnage affects price if over a basic included amount
                    const estimatedTonnage = parseFloat(estimatedTonnageInput.value) || 0;
                    // If estimated tonnage exceeds the equipment's maxTonnage (which we can assume is included in base rate)
                    if (estimatedTonnage > (selectedEquipment.maxTonnage || 0)) { 
                         calculatedPrice += (estimatedTonnage - (selectedEquipment.maxTonnage || 0)) * (selectedEquipment.overagePerTonFee || 0);
                    }
                    // Add flat disposal rate per ton for all estimated tonnage
                    calculatedPrice += (estimatedTonnage * (selectedEquipment.disposalRatePerTon || 0)); 
                } else if (selectedEquipment.type === 'Temporary Toilet') {
                    // For demo, assume each service frequency is X services per rental period, add Y cost per service
                    const serviceFreq = requestedServiceFreqSelect.value;
                    let numServices = 0;
                    if (serviceFreq === 'Weekly') {
                        numServices = Math.floor(dayDiff / 7);
                    } else if (serviceFreq === 'Bi-weekly') {
                        numServices = Math.floor(dayDiff / 14);
                    } else if (serviceFreq === 'Event-specific' && dayDiff < 7) { // Assume 1 service for short events
                        numServices = 1;
                    }
                    calculatedPrice += numServices * 20; // Dummy cost per service for toilet servicing
                }
            }
        }
        totalPriceInput.value = calculatedPrice.toFixed(2);
    }

    // --- CRUD Operations ---
    function renderBookingsTable(dataToRender = bookingData) {
        console.log("Rendering booking table with data:", dataToRender);
        bookingTableBody.innerHTML = '';
        if (!Array.isArray(dataToRender) || dataToRender.length === 0) {
            const row = bookingTableBody.insertRow();
            row.innerHTML = '<td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No bookings found.</td>';
            return;
        }
        dataToRender.forEach(booking => {
            const row = bookingTableBody.insertRow();
            row.classList.add('hover:bg-gray-50');

            // Find linked customer and equipment for display
            const customer = customerData.find(c => c.id === booking.customerId);
            const equipment = equipmentData.find(e => e.id === booking.equipmentId);

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900');
            row.cells[0].textContent = booking.id;

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
            row.cells[1].textContent = customer ? customer.name : booking.customerId;

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
            row.cells[2].textContent = equipment ? `${equipment.type} (${equipment.size})` : booking.equipmentId;

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
            row.cells[3].textContent = booking.rentalStartDate;

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
            row.cells[4].textContent = booking.rentalEndDate;

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
            row.cells[5].textContent = booking.status;

            const actionsCell = row.insertCell();
            actionsCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-right', 'text-sm', 'font-medium');

            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'View';
            viewBtn.classList.add('text-indigo-600', 'hover:text-indigo-900', 'mr-3', 'transition-colors', 'duration-200');
            viewBtn.onclick = () => viewBookingDetails(booking.id);
            actionsCell.appendChild(viewBtn);

            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.classList.add('text-[#EA3A26]', 'hover:text-[#F54F1D]', 'mr-3', 'transition-colors', 'duration-200');
            editBtn.onclick = () => openEditModal(booking.id);
            actionsCell.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.classList.add('text-red-600', 'hover:text-red-900', 'transition-colors', 'duration-200');
            deleteBtn.onclick = () => deleteBooking(booking.id);
            actionsCell.appendChild(deleteBtn);
        });
    }

    function openAddModal() {
        modalTitle.textContent = 'Create New Booking';
        bookingIdField.value = '';
        bookingForm.reset();
        currentBookingId = null;
        currentSelectedEquipmentIdForEdit = null; // Clear for add mode
        populateDropdowns(); // Ensure dropdowns are fresh
        hideAllTypeSpecificBookingFields(); // Hide type-specific fields for new entry
        calculatePrice(); // Recalculate initial price
        openModal('bookingModal');
    }

    function openEditModal(id) {
        const booking = bookingData.find(b => b.id === id);
        if (booking) {
            modalTitle.textContent = `Edit Booking: ${booking.id}`;
            bookingIdField.value = booking.id;
            currentSelectedEquipmentIdForEdit = booking.equipmentId; // Keep track for populating dropdown
            populateDropdowns(); // Populate first, then set selected value

            document.getElementById('customerIdSelect').value = booking.customerId;
            document.getElementById('equipmentIdSelect').value = booking.equipmentId;
            document.getElementById('rentalStartDate').value = booking.rentalStartDate;
            document.getElementById('rentalEndDate').value = booking.rentalEndDate;
            document.getElementById('deliveryAddress').value = booking.deliveryAddress;
            document.getElementById('pickupAddress').value = booking.pickupAddress || '';
            document.getElementById('bookingStatus').value = booking.status;
            document.getElementById('bookingNotes').value = booking.bookingNotes || '';

            // Populate type-specific booking fields for edit
            const selectedEquipment = equipmentData.find(eq => eq.id === booking.equipmentId);
            if (selectedEquipment) {
                handleEquipmentSelection(); // Show correct fields based on selected equipment type
                if (selectedEquipment.type === 'Dumpster') {
                    estimatedTonnageInput.value = booking.estimatedTonnage || '';
                    prohibitedMaterialsAckInput.value = booking.prohibitedMaterialsAck || '';
                } else if (selectedEquipment.type === 'Temporary Toilet') {
                    requestedServiceFreqSelect.value = booking.requestedServiceFreq || 'Weekly';
                    toiletSpecialRequestsInput.value = booking.toiletSpecialRequests || '';
                } else if (selectedEquipment.type === 'Storage Container') {
                    containerPlacementNotesInput.value = booking.containerPlacementNotes || '';
                    containerSecurityAccessInput.value = booking.containerSecurityAccess || '';
                }
            }
            
            calculatePrice(); // Ensure price is calculated after all fields are set

            currentBookingId = id;
            openModal('bookingModal');
        } else {
            alert('Booking not found for editing.');
        }
    }

    function saveBooking(event) {
        event.preventDefault();

        const id = bookingIdField.value;
        const customerId = document.getElementById('customerIdSelect').value;
        const equipmentId = document.getElementById('equipmentIdSelect').value;
        const rentalStartDate = rentalStartDateInput.value;
        const rentalEndDate = rentalEndDateInput.value;
        const deliveryAddress = document.getElementById('deliveryAddress').value;
        const pickupAddress = document.getElementById('pickupAddress').value;
        const status = document.getElementById('bookingStatus').value;
        const totalPrice = parseFloat(totalPriceInput.value) || 0; // Use calculated price
        const bookingNotes = document.getElementById('bookingNotes').value;

        if (!customerId || !equipmentId || !rentalStartDate || !rentalEndDate || !deliveryAddress || !status) {
            alert('Please fill in all required booking fields (Customer, Equipment, Dates, Delivery Address, Status).');
            return;
        }

        let newBooking = {
            id: id,
            customerId: customerId,
            equipmentId: equipmentId,
            rentalStartDate: rentalStartDate,
            rentalEndDate: rentalEndDate,
            deliveryAddress: pickupAddress || deliveryAddress, // Default pickup to delivery if empty
            status: status,
            totalPrice: totalPrice,
            bookingNotes: bookingNotes,
            driverId: '' // Default to unassigned, can be assigned in Driver module
        };

        // Add type-specific booking data
        const selectedEquipment = equipmentData.find(eq => eq.id === equipmentId);
        if (selectedEquipment) {
            if (selectedEquipment.type === 'Dumpster') {
                newBooking.estimatedTonnage = parseFloat(estimatedTonnageInput.value) || 0;
                newBooking.prohibitedMaterialsAck = prohibitedMaterialsAckInput.value;
            } else if (selectedEquipment.type === 'Temporary Toilet') {
                newBooking.requestedServiceFreq = requestedServiceFreqSelect.value;
                newBooking.toiletSpecialRequests = toiletSpecialRequestsInput.value;
            } else if (selectedEquipment.type === 'Storage Container') {
                newBooking.containerPlacementNotes = containerPlacementNotesInput.value;
                newBooking.containerSecurityAccess = containerSecurityAccessInput.value;
            }
        }

        if (id) {
            const index = bookingData.findIndex(b => b.id === id);
            if (index !== -1) {
                // Preserve driverId if editing an existing booking
                newBooking.driverId = bookingData[index].driverId || ''; 
                bookingData[index] = newBooking;
                alert(`Booking ${id} updated successfully!`);
            } else {
                alert(`Error: Booking ${id} not found for update.`);
            }
        } else {
            newBooking.id = 'BOOK' + (bookingData.length + 1).toString().padStart(3, '0');
            bookingData.push(newBooking);
            alert(`New booking ${newBooking.id} created successfully!`);
        }

        renderBookingsTable();
        closeModal('bookingModal');
    }

    function deleteBooking(id) {
        if (confirm(`Are you sure you want to delete booking ID: ${id}? This action cannot be undone.`)) {
            bookingData = bookingData.filter(b => b.id !== id);
            renderBookingsTable();
            alert(`Booking ${id} deleted successfully.`);
        }
    }

    function viewBookingDetails(id) {
        const booking = bookingData.find(b => b.id === id);
        if (booking) {
            const customer = customerData.find(c => c.id === booking.customerId);
            const equipment = equipmentData.find(e => e.id === booking.equipmentId);

            detailBookingId.textContent = booking.id;
            detailCustomerName.textContent = customer ? customer.name : booking.customerId;
            detailCustomerId.textContent = booking.customerId;
            detailEquipmentDisplay.textContent = equipment ? `${equipment.type} (${equipment.size})` : booking.equipmentId;
            detailEquipmentId.textContent = booking.equipmentId;
            detailRentalStartDate.textContent = booking.rentalStartDate;
            detailRentalEndDate.textContent = booking.rentalEndDate;
            detailDeliveryAddress.textContent = booking.deliveryAddress;
            detailPickupAddress.textContent = booking.pickupAddress || 'N/A';
            detailTotalPriceDisplay.textContent = booking.totalPrice.toFixed(2);

            // Status styling
            detailBookingStatus.textContent = booking.status;
            detailBookingStatus.classList.remove('bg-green-600', 'bg-[#FF8600]', 'bg-gray-500', 'bg-blue-600', 'bg-red-600'); // Remove previous colors
            if (booking.status === 'Confirmed') {
                detailBookingStatus.classList.add('bg-green-600');
            } else if (booking.status === 'Pending') {
                detailBookingStatus.classList.add('bg-[#FF8600]'); // UT Orange
            } else if (booking.status === 'Delivered') {
                 detailBookingStatus.classList.add('bg-blue-600');
            } else if (booking.status === 'Completed') {
                detailBookingStatus.classList.add('bg-gray-500');
            } else if (booking.status === 'Cancelled') {
                detailBookingStatus.classList.add('bg-red-600');
            }

            // Hide all type-specific booking detail fields first
            detailDumpsterBookingFields.classList.add('hidden');
            detailToiletBookingFields.classList.add('hidden');
            detailContainerBookingFields.classList.add('hidden');

            // Show and populate relevant type-specific booking detail fields
            if (equipment) { // Only if equipment is found
                if (equipment.type === 'Dumpster') {
                    detailDumpsterBookingFields.classList.remove('hidden');
                    detailEstimatedTonnage.textContent = booking.estimatedTonnage || 'N/A';
                    detailProhibitedMaterialsAck.textContent = booking.prohibitedMaterialsAck || 'N/A';
                } else if (equipment.type === 'Temporary Toilet') {
                    detailToiletBookingFields.classList.remove('hidden');
                    detailRequestedServiceFreq.textContent = booking.requestedServiceFreq || 'N/A';
                    detailToiletSpecialRequests.textContent = booking.toiletSpecialRequests || 'N/A';
                } else if (equipment.type === 'Storage Container') {
                    detailContainerBookingFields.classList.remove('hidden');
                    detailContainerPlacementNotes.textContent = booking.containerPlacementNotes || 'N/A';
                    detailContainerSecurityAccess.textContent = booking.containerSecurityAccess || 'N/A';
                }
            }


            if (booking.bookingNotes) {
                detailBookingNotesGroup.classList.remove('hidden');
                detailBookingNotes.textContent = booking.bookingNotes;
            } else {
                detailBookingNotesGroup.classList.add('hidden');
            }

            currentBookingId = id; // Set for edit button from detail view
            openModal('viewBookingModal');
        } else {
            alert('Booking details not found.');
        }
    }

    // --- Filtering and Searching ---
    function filterBookings() {
        const searchTerm = document.getElementById('bookingSearch').value.toLowerCase();
        const statusFilter = document.getElementById('bookingStatusFilter').value;
        const dateFilter = document.getElementById('bookingDateFilter').value;

        const filteredData = bookingData.filter(booking => {
            const customer = customerData.find(c => c.id === booking.customerId);
            const customerName = customer ? customer.name.toLowerCase() : '';
            const equipment = equipmentData.find(e => e.id === booking.equipmentId);
            const equipmentType = equipment ? equipment.type.toLowerCase() : '';

            const matchesSearch = booking.id.toLowerCase().includes(searchTerm) ||
                                  customerName.includes(searchTerm) ||
                                  equipmentType.includes(searchTerm) ||
                                  (booking.bookingNotes && booking.bookingNotes.toLowerCase().includes(searchTerm));
            const matchesStatus = statusFilter === '' || booking.status === statusFilter;
            const matchesDate = dateFilter === '' || booking.rentalStartDate === dateFilter || booking.rentalEndDate === dateFilter;

            return matchesSearch && matchesStatus && matchesDate;
        });

        renderBookingsTable(filteredData);
    }

    // Initial render when the module loads
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        populateDropdowns();
        renderBookingsTable();
    } else {
        document.addEventListener('DOMContentLoaded', () => {
            populateDropdowns();
            renderBookingsTable();
        });
    }

</script>