<div class="p-8">
    <h2 class="text-3xl font-bold text-gray-900 mb-6">Dispatching & Route Optimization</h2>

    <div class="flex border-b border-gray-200 mb-8 space-x-6">
        <span class="dispatch-tab py-2 px-0 cursor-pointer font-bold text-gray-500 transition-colors duration-300 hover:text-gray-800 border-b-2 border-transparent text-[#EA3A26] border-[#EA3A26]" data-view="board">Driver Board</span>
        <span class="dispatch-tab py-2 px-0 cursor-pointer font-bold text-gray-500 transition-colors duration-300 hover:text-gray-800 border-b-2 border-transparent" data-view="list">Job List</span>
        <span class="dispatch-tab py-2 px-0 cursor-pointer font-bold text-gray-500 transition-colors duration-300 hover:text-gray-800 border-b-2 border-transparent" data-view="map">Map View (Conceptual)</span>
        <span class="dispatch-tab py-2 px-0 cursor-pointer font-bold text-gray-500 transition-colors duration-300 hover:text-gray-800 border-b-2 border-transparent" data-view="calendar">Driver Schedule (Conceptual)</span>
    </div>

    <div id="dispatch-view-board" class="dispatch-content-view">
        <div class="flex flex-col md:flex-row items-start justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800 mb-2 md:mb-0">Job Assignment Board</h3>
            <button onclick="simulateRouteOptimization()" class="px-6 py-2 bg-blue-600 text-white rounded-md font-semibold hover:bg-blue-700 transition-colors duration-200 flex items-center gap-2">
                <i class="fas fa-route"></i> Simulate Route Optimization
            </button>
        </div>
        <div class="flex overflow-x-auto pb-4 -mx-2">
            <div class="flex-none w-80 bg-gray-100 p-4 rounded-lg shadow-md mr-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 border-gray-300">Unassigned Jobs</h3>
                <div id="unassignedJobsContainer" class="space-y-3 min-h-[200px]">
                    <p class="text-gray-500 italic text-center py-4 text-sm">Loading jobs...</p>
                    </div>
            </div>

            <div id="driverColumnsContainer" class="flex flex-grow overflow-x-auto">
                <p class="text-gray-500 italic text-center py-4 text-sm w-full">Loading drivers...</p>
                </div>
        </div>
    </div>

    <div id="dispatch-view-list" class="dispatch-content-view hidden">
        <div class="bg-white rounded-lg shadow-md overflow-x-auto p-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 border-gray-300">All Bookings List</h3>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booking ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Equipment</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Driver</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="dispatchListViewTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="dispatch-view-map" class="dispatch-content-view hidden">
        <div class="bg-white p-8 rounded-lg shadow-md text-center h-full flex flex-col items-center justify-center">
            <i class="fas fa-map-marked-alt text-6xl text-gray-400 mb-4"></i>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Map View - Intelligent Route Optimization & Real-time Tracking</h3>
            <p class="text-gray-600 max-w-2xl mx-auto mb-6">
                This is the **live command center** of your dispatch operations. In a real system, powered by Google Maps Platform, it would offer:
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto text-left">
                <div class="p-4 bg-gray-50 rounded-md shadow-sm">
                    <h4 class="font-semibold text-lg text-blue-700 mb-2">Real-time Tracking & Visibility</h4>
                    <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                        <li><strong>Live Map:</strong> Shows all active drivers, their current locations, and assigned routes.</li>
                        <li><strong>Driver & Job Status:</strong> Color-coded job pins (Red: Unassigned, Yellow: Pending, Blue: En Route, Green: Completed) and driver icons indicating status (On Route, Idle).</li>
                        <li><strong>Real-time Updates:</strong> Driver updates (e.g., "Arrived," "Job Complete") reflected instantly on the map.</li>
                        <li><strong>ETA & Progress:</strong> Track estimated time of arrival to next stop and overall route progress.</li>
                    </ul>
                </div>
                <div class="p-4 bg-gray-50 rounded-md shadow-sm">
                    <h4 class="font-semibold text-lg text-blue-700 mb-2">Intelligent Route Optimization</h4>
                    <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                        <li><strong>Multi-stop & Multi-driver Optimization:</strong> Automatically generates the most efficient routes.</li>
                        <li><strong>Constraint Consideration:</strong> Accounts for time windows, vehicle capacity, driver skills, traffic (real-time & historical), and road restrictions.</li>
                        <li><strong>Dynamic Adjustments:</strong> Ability to re-optimize routes on the fly for last-minute changes, new orders, or delays.</li>
                        <li><strong>Geofencing:</strong> Define virtual boundaries for arrival/departure alerts and time tracking at locations.</li>
                        <li><strong>Drag-and-Drop:</strong> Visually reassign jobs by dragging pins to different routes (in a truly interactive version).</li>
                    </ul>
                </div>
            </div>
            <img src="https://via.placeholder.com/800x450/E0E0E0/6C757D?text=Placeholder+Map+View" alt="Map View Placeholder" class="mt-8 rounded-lg shadow-lg border border-gray-200">
            <p class="text-gray-600 text-sm mt-4">
                (This view would be powered by direct integration with Google Maps Platform APIs - Geocoding, Distance Matrix, Routes API - requiring a backend and billing setup.)
            </p>
        </div>
    </div>

    <div id="dispatch-view-calendar" class="dispatch-content-view hidden">
        <div class="bg-white p-8 rounded-lg shadow-md text-center h-full flex flex-col items-center justify-center">
            <i class="fas fa-calendar-day text-6xl text-gray-400 mb-4"></i>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Driver Schedule / Timeline View (Gantt-style)</h3>
            <p class="text-gray-600 max-w-xl mx-auto mb-6">
                This view provides a visual timeline for comprehensive scheduling and workload management:
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl mx-auto text-left">
                <div class="p-4 bg-gray-50 rounded-md shadow-sm">
                    <h4 class="font-semibold text-lg text-blue-700 mb-2">Detailed Scheduling</h4>
                    <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                        <li><strong>Visual Timeline:</strong> Each driver as a row, showing assigned routes, breaks, and availability across a time axis.</li>
                        <li><strong>Workload Balancing:</strong> Easily identify over- or under-utilized drivers.</li>
                        <li><strong>Conflict Detection:</strong> Spot scheduling conflicts or overlapping jobs.</li>
                    </ul>
                </div>
                <div class="p-4 bg-gray-50 rounded-md shadow-sm">
                    <h4 class="font-semibold text-lg text-blue-700 mb-2">Availability & Compliance</h4>
                    <ul class="list-disc list-inside ml-4 text-sm space-y-1">
                        <li><strong>Driver Availability:</strong> Visually manage driver shifts, time-off requests, and current availability status.</li>
                        <li><strong>Hours of Service (HOS) Tracking:</strong> Monitor compliance with regulations to prevent fatigue and ensure legal operation.</li>
                    </ul>
                </div>
            </div>
            <img src="https://via.placeholder.com/800x450/E0E0E0/6C757D?text=Placeholder+Gantt+Chart" alt="Gantt Chart Placeholder" class="mt-8 rounded-lg shadow-lg border border-gray-200">
            <p class="text-gray-600 text-sm mt-4">
                (This feature is typically built with specialized Gantt chart libraries or robust frontend frameworks for complex interactive timelines.)
            </p>
        </div>
    </div>

    <div id="jobActionModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 max-w-md relative">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl font-bold" onclick="closeModal('jobActionModal')">&times;</button>
            <h3 id="jobActionModalTitle" class="text-2xl font-bold text-[#EA3A26] mb-6 border-b pb-3 border-gray-200">Assign Job</h3>
            <div class="space-y-4">
                <p><strong>Booking:</strong> <span id="modalBookingInfo"></span></p>
                <p><strong>Current Driver:</strong> <span id="modalCurrentDriver">Unassigned</span></p>

                <div id="assignDriverField">
                    <label for="assignDriverSelect" class="block text-sm font-medium text-gray-700 mb-1">Assign to Driver:</label>
                    <select id="assignDriverSelect"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-[#EA3A26] focus:border-[#EA3A26]">
                        <option value="">Select Driver</option>
                        </select>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md font-semibold hover:bg-gray-400 transition-colors duration-200" onclick="closeModal('jobActionModal')">Cancel</button>
                    <button type="button" id="confirmAssignBtn" class="px-6 py-2 bg-[#EA3A26] text-white rounded-md font-semibold hover:bg-[#F54F1D] transition-colors duration-200" onclick="confirmJobAssignment()">Confirm Assignment</button>
                    <button type="button" id="unassignBtn" class="px-6 py-2 bg-red-600 text-white rounded-md font-semibold hover:bg-red-700 transition-colors duration-200 hidden" onclick="unassignJob()">Unassign Job</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Ensure global data is accessible or provide minimal fallbacks
    // These fallbacks are for direct file loading; in a full app, data would come from a backend.
    if (typeof window.driverData === 'undefined' || !Array.isArray(window.driverData)) {
        console.warn("driverData not found. Using minimal fallback dummy data for drivers.");
        window.driverData = [
            { id: 'DRV001', name: 'Michael Scott', assignedVehicle: 'Truck 101', status: 'Active' },
            { id: 'DRV002', name: 'Dwight Schrute', assignedVehicle: 'Truck 102', status: 'Active' },
            { id: 'DRV003', name: 'Pam Beesly', assignedVehicle: 'Van 3', status: 'On Leave' }
        ];
    }
    if (typeof window.bookingData === 'undefined' || !Array.isArray(window.bookingData)) {
        console.warn("bookingData not found. Using minimal fallback dummy data for bookings.");
        window.bookingData = [
            { id: 'BOOK001', customerId: 'CUST001', equipmentId: 'EQ001', rentalStartDate: '2025-07-25', rentalEndDate: '2025-07-30', status: 'Confirmed', driverId: 'DRV001', deliveryAddress: '123 Main St' },
            { id: 'BOOK002', customerId: 'CUST002', equipmentId: 'EQ002', rentalStartDate: '2025-08-01', rentalEndDate: '2025-08-01', status: 'Pending', driverId: '', deliveryAddress: '789 Oak Ave' },
            { id: 'BOOK003', customerId: 'CUST001', equipmentId: 'EQ003', rentalStartDate: '2025-07-20', rentalEndDate: '2025-08-20', status: 'Delivered', driverId: 'DRV002', deliveryAddress: '456 Elm St' }
        ];
    }
    if (typeof window.customerData === 'undefined' || !Array.isArray(window.customerData)) {
        console.warn("customerData not found. Using minimal fallback dummy data for customers.");
        window.customerData = [
            { id: 'CUST001', name: 'Alice Smith' },
            { id: 'CUST002', name: 'Bob Johnson' },
        ];
    }
    if (typeof window.equipmentData === 'undefined' || !Array.isArray(window.equipmentData)) {
        console.warn("equipmentData not found. Using minimal fallback dummy data for equipment.");
        window.equipmentData = [
            { id: 'EQ001', type: 'Dumpster', size: '20-yard' },
            { id: 'EQ002', type: 'Temporary Toilet', size: 'Standard' },
            { id: 'EQ003', type: 'Storage Container', size: '40ft' }
        ];
    }

    let driverData = window.driverData;
    let bookingData = window.bookingData;
    let customerData = window.customerData;
    let equipmentData = window.equipmentData;

    let currentJobToAssign = null; // Stores the booking ID being acted upon in the modal

    // Get elements
    const dispatchTabs = document.querySelectorAll('.dispatch-tab');
    const dispatchContentViews = document.querySelectorAll('.dispatch-content-view');

    // Driver Board View elements
    const unassignedJobsContainer = document.getElementById('unassignedJobsContainer');
    const driverColumnsContainer = document.getElementById('driverColumnsContainer');

    // List View elements
    const dispatchListViewTableBody = document.getElementById('dispatchListViewTableBody');

    // Job Action Modal elements
    const jobActionModal = document.getElementById('jobActionModal');
    const jobActionModalTitle = document.getElementById('jobActionModalTitle');
    const modalBookingInfo = document.getElementById('modalBookingInfo');
    const modalCurrentDriver = document.getElementById('modalCurrentDriver');
    const assignDriverField = document.getElementById('assignDriverField');
    const assignDriverSelect = document.getElementById('assignDriverSelect');
    const confirmAssignBtn = document.getElementById('confirmAssignBtn');
    const unassignBtn = document.getElementById('unassignBtn');

    // --- Modal Functions ---
    function openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        if (modalId === 'jobActionModal') {
            currentJobToAssign = null; // Clear the current job context
        }
    }

    // --- View Switching ---
    function switchDispatchView(viewName) {
        dispatchContentViews.forEach(view => view.classList.add('hidden'));
        document.getElementById(`dispatch-view-${viewName}`).classList.remove('hidden');

        // Update active tab styling
        dispatchTabs.forEach(tab => {
            tab.classList.remove('text-[#EA3A26]', 'border-[#EA3A26]');
            tab.classList.add('text-gray-500', 'border-transparent');
        });
        const activeTab = Array.from(dispatchTabs).find(tab => tab.dataset.view === viewName);
        if (activeTab) {
            activeTab.classList.add('text-[#EA3A26]', 'border-[#EA3A26]');
            activeTab.classList.remove('text-gray-500', 'border-transparent');
        }


        // Render content for the active view
        if (viewName === 'board') {
            renderDriverBoardView();
        } else if (viewName === 'list') {
            renderListView();
        }
        // No rendering needed for conceptual views
    }

    // --- Driver Board View (Simulated Drag & Drop) ---
    function renderDriverBoardView() {
        unassignedJobsContainer.innerHTML = '';
        driverColumnsContainer.innerHTML = '';

        const unassignedBookings = bookingData.filter(b => !b.driverId);
        if (unassignedBookings.length === 0) {
            unassignedJobsContainer.innerHTML = '<p class="text-gray-500 italic text-center py-4">All jobs assigned!</p>';
        } else {
            unassignedBookings.forEach(booking => {
                unassignedJobsContainer.appendChild(createJobCard(booking));
            });
        }

        const activeDrivers = driverData.filter(d => d.status === 'Active');
        if (activeDrivers.length === 0) {
            driverColumnsContainer.innerHTML = '<p class="text-gray-500 italic text-center py-4 w-full">No active drivers available for assignment.</p>';
        } else {
            activeDrivers.forEach(driver => {
                const driverColumn = document.createElement('div');
                driverColumn.classList.add('flex-none', 'w-80', 'bg-gray-100', 'p-4', 'rounded-lg', 'shadow-md', 'mr-4');
                driverColumn.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 border-gray-300">
                        ${driver.name} <span class="text-sm text-gray-500">(${driver.assignedVehicle || 'No Vehicle'})</span>
                    </h3>
                    <div id="driver-jobs-${driver.id}" class="space-y-3 min-h-[150px]">
                        </div>
                `;
                driverColumnsContainer.appendChild(driverColumn);

                const assignedJobsForDriver = bookingData.filter(b => b.driverId === driver.id);
                const driverJobsContainer = document.getElementById(`driver-jobs-${driver.id}`);
                if (assignedJobsForDriver.length === 0) {
                    driverJobsContainer.innerHTML = '<p class="text-gray-500 italic text-center py-4 text-sm">No assigned jobs.</p>';
                } else {
                    assignedJobsForDriver.forEach(booking => {
                        driverJobsContainer.appendChild(createJobCard(booking));
                    });
                }
            });
        }
    }

    function createJobCard(booking) {
        const customer = customerData.find(c => c.id === booking.customerId);
        const equipment = equipmentData.find(e => e.id === booking.equipmentId);
        // const driver = driverData.find(d => d.id === booking.driverId); // Not used directly in card, but available

        const card = document.createElement('div');
        card.classList.add('bg-white', 'p-3', 'rounded-md', 'shadow-sm', 'border', 'border-gray-200', 'cursor-pointer', 'hover:shadow-md', 'transition-shadow');
        card.innerHTML = `
            <p class="font-semibold text-gray-800">${booking.id} - ${customer ? customer.name : 'Unknown Customer'}</p>
            <p class="text-sm text-gray-600">${equipment ? `${equipment.type} (${equipment.size})` : 'Unknown Equipment'}</p>
            <p class="text-xs text-gray-500">Delivery: ${booking.rentalStartDate} to ${booking.deliveryAddress}</p>
            <p class="text-xs ${booking.status === 'Pending' ? 'text-[#FF8600]' : booking.status === 'Confirmed' ? 'text-green-600' : 'text-gray-500'}">Status: ${booking.status}</p>
        `;
        card.onclick = () => openJobActionModal(booking.id);
        return card;
    }

    function openJobActionModal(bookingId) {
        currentJobToAssign = bookingId;
        const booking = bookingData.find(b => b.id === bookingId);
        if (!booking) return;

        const customer = customerData.find(c => c.id === booking.customerId);
        const equipment = equipmentData.find(e => e.id === booking.equipmentId);
        const currentDriver = driverData.find(d => d.id === booking.driverId);

        modalBookingInfo.textContent = `${booking.id} - ${customer ? customer.name : 'Unknown Customer'} - ${equipment ? equipment.type : 'Unknown Equipment'}`;
        modalCurrentDriver.textContent = currentDriver ? currentDriver.name : 'Unassigned';

        // Populate driver dropdown for assignment
        assignDriverSelect.innerHTML = '<option value="">Select Driver</option>';
        driverData.filter(d => d.status === 'Active').forEach(driver => { // Only active drivers can be assigned
            const option = document.createElement('option');
            option.value = driver.id;
            option.textContent = driver.name;
            if (currentDriver && driver.id === currentDriver.id) {
                option.selected = true; // Pre-select current driver
            }
            assignDriverSelect.appendChild(option);
        });

        // Configure modal buttons based on current assignment status
        if (booking.driverId) {
            jobActionModalTitle.textContent = 'Reassign Job';
            confirmAssignBtn.textContent = 'Change Assignment';
            unassignBtn.classList.remove('hidden');
            assignDriverField.classList.remove('hidden');
        } else {
            jobActionModalTitle.textContent = 'Assign Job';
            confirmAssignBtn.textContent = 'Assign Job';
            unassignBtn.classList.add('hidden'); // Hide unassign button if no driver is assigned
            assignDriverField.classList.remove('hidden');
        }

        openModal('jobActionModal');
    }

    function confirmJobAssignment() {
        const booking = bookingData.find(b => b.id === currentJobToAssign);
        const selectedDriverId = assignDriverSelect.value;

        if (booking) {
            if (selectedDriverId) {
                booking.driverId = selectedDriverId;
                alert(`Booking ${booking.id} assigned to ${driverData.find(d => d.id === selectedDriverId).name}`);
            } else {
                alert('Please select a driver or cancel.');
                return;
            }
        }
        renderDriverBoardView(); // Re-render the board to reflect changes
        closeModal('jobActionModal');
    }

    function unassignJob() {
        if (confirm(`Are you sure you want to unassign Booking ${currentJobToAssign}?`)) {
            const booking = bookingData.find(b => b.id === currentJobToAssign);
            if (booking) {
                booking.driverId = ''; // Set to unassigned
                alert(`Booking ${booking.id} unassigned.`);
            }
            renderDriverBoardView(); // Re-render the board to reflect changes
            closeModal('jobActionModal');
        }
    }

    function simulateRouteOptimization() {
        const unassignedCount = bookingData.filter(b => !b.driverId).length;
        const driverCount = driverData.filter(d => d.status === 'Active').length;

        let simulationMessage = `Simulating Route Optimization Process (Google Maps API Integration):\n\n`;
        simulationMessage += `Step 1: Gathering ${unassignedCount} unassigned jobs, ${driverCount} active drivers, time windows, and vehicle capacities.\n`;
        simulationMessage += `Step 2: Using Google Maps Platform APIs (Geocoding, Distance Matrix) to calculate precise distances and travel times between all points, considering real-time traffic.\n`;
        simulationMessage += `Step 3: Solving the Vehicle Routing Problem (VRP) algorithm to determine the most efficient routes that minimize travel time, respect time windows, and balance workload.\n`;
        simulationMessage += `Step 4: Optimized routes are generated and displayed on the Map View for dispatcher review. They can then be dispatched to drivers' mobile apps.\n\n`;
        simulationMessage += `(Note: This is a simulation. Actual optimization would happen in a backend service connected to Google Maps APIs.)`;

        alert(simulationMessage);
        console.log(simulationMessage);
    }


    // --- List View ---
    function renderListView() {
        dispatchListViewTableBody.innerHTML = '';
        if (bookingData.length === 0) {
            const row = dispatchListViewTableBody.insertRow();
            row.innerHTML = '<td colspan="7" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No bookings found.</td>';
            return;
        }

        bookingData.forEach(booking => {
            const customer = customerData.find(c => c.id === booking.customerId);
            const equipment = equipmentData.find(e => e.id === booking.equipmentId);
            const driver = driverData.find(d => d.id === booking.driverId);

            const row = dispatchListViewTableBody.insertRow();
            row.classList.add('hover:bg-gray-50');

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'text-gray-900');
            row.cells[0].textContent = booking.id;

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
            row.cells[1].textContent = customer ? customer.name : booking.customerId;

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
            row.cells[2].textContent = equipment ? `${equipment.type} (${equipment.size})` : booking.equipmentId;

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
            row.cells[3].textContent = booking.rentalStartDate;

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
            row.cells[4].textContent = booking.rentalEndDate;

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
            row.cells[5].textContent = driver ? driver.name : 'Unassigned';

            row.insertCell().classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'text-gray-500');
            row.cells[6].textContent = booking.status;


            const actionsCell = row.insertCell();
            actionsCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-right', 'text-sm', 'font-medium');
            const viewBtn = document.createElement('button');
            viewBtn.textContent = 'View Job';
            viewBtn.classList.add('text-indigo-600', 'hover:text-indigo-900', 'transition-colors', 'duration-200');
            viewBtn.onclick = () => alert(`Viewing details for Booking ID: ${booking.id}\n(In a real app, this would open the booking details modal from the Bookings module.)`);
            actionsCell.appendChild(viewBtn);
        });
    }


    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        // Attach event listeners for tabs
        dispatchTabs.forEach(tab => {
            tab.addEventListener('click', (event) => {
                switchDispatchView(event.target.dataset.view);
            });
        });

        // Set initial view to Driver Board
        switchDispatchView('board');
    });

    // Ensure initial render on dynamic module load
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        switchDispatchView('board');
    } else {
        document.addEventListener('DOMContentLoaded', () => switchDispatchView('board'));
    }

</script>